 .header { background: #111; }
        body.dark-mode .receipt-bubble .footer { background: #222; }

        /* [优化] 翻译/转文字/转发/音乐/代码片段气泡 */
        .translated-text-bubble, .voice-transcribed-bubble { 
            background: var(--wechat-nav-bg);
            color: var(--wechat-text-primary); 
            padding: 10px 14px; 
            border-radius: 6px; 
            margin-top: 5px; 
            font-size: calc(var(--font-size-base) - 1px); 
            border: 0.5px solid var(--wechat-border-color); 
            max-width: calc(var(--phone-width) - 120px); 
            word-break: break-word;
            position: relative;
        }
        /* [新增] 翻译气泡的特殊样式 */
        .translated-text-bubble::before {
            content: '[译文]';
            font-weight: bold;
            color: var(--wechat-blue);
            margin-right: 5px;
        }
        .forwarded-message-bubble, .music-bubble {
            background: #fff;
            color: var(--wechat-text-primary);
            padding: 10px 14px;
            border-radius: 6px;
            border: 0.5px solid var(--wechat-border-color);
            max-width: calc(var(--phone-width) - 120px);
            word-break: break-word;
            cursor: pointer;
        }
        .forwarded-message-bubble {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .forwarded-message-bubble i {
            font-size: 20px;
            color: var(--wechat-text-secondary);
        }
        body.dark-mode .forwarded-message-bubble, body.dark-mode .music-bubble {
            background: var(--wechat-nav-bg);
            border-color: var(--wechat-border-color);
        }
        .music-bubble { display: flex; align-items: center; gap: 10px; }
        .music-bubble img { width: 40px; height: 40px; border-radius: 4px; }
        .music-bubble .details { flex: 1; }
        .music-bubble .details .title { font-weight: 500; }
        .music-bubble .details .artist { font-size: 12px; color: var(--wechat-text-secondary); }
        .html-content-bubble { padding: 5px; background: #fff; }
        .html-content-iframe { width: 260px; height: 560px; border: none; resize: both; overflow: auto; }


        /* 时间戳样式 */
        .message-timestamp-under { font-size: calc(var(--font-size-base) - 3px); color: var(--wechat-text-secondary); margin-top: 4px; }
        .message-timestamp-inside { font-size: 10px; opacity: 0.7; margin-top: 5px; color: inherit; }
        .message-row.sent .message-bubble .message-timestamp-inside { color: #000; }

        /* 聊天输入栏 */
        .chat-input-bar { display: flex; align-items: center; padding: 8px 10px; gap: 10px; background: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); }
        .chat-input-bar input { flex: 1; padding: 8px 12px; border: none; background: var(--wechat-bg); border-radius: 6px; font-size: var(--font-size-base); color: var(--wechat-text-primary); }
        .chat-input-bar i { font-size: 28px; cursor: pointer; color: var(--wechat-text-secondary); }
        .chat-plus-menu { position: absolute; bottom: 50px; left: 0; right: 0; background: var(--wechat-bg); display: none; grid-template-columns: repeat(4, 1fr); padding: 20px; gap: 20px; z-index: 10; border-top: 0.5px solid var(--wechat-border-color); }
        .plus-menu-item { display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: calc(var(--font-size-base) - 3px); color: var(--wechat-text-secondary); cursor: pointer; }
        .plus-menu-item .icon { width: 56px; height: 56px; background: var(--wechat-nav-bg); border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 28px; color: var(--wechat-text-secondary); border: 0.5px solid var(--wechat-border-color); }

        /* --- 消息上下文菜单 --- */
        .message-context-menu { position: fixed; background: #4c4c4c; color: white; border-radius: 8px; padding: 5px; display: none; z-index: 1100; }
        .context-menu-item { padding: 8px 15px; cursor: pointer; white-space: nowrap; position: relative; font-size: var(--font-size-base); }
        .context-menu-item:hover { background: #666; }
        .context-submenu { display: none; position: absolute; left: 100%; top: 0; background: #4c4c4c; border-radius: 8px; padding: 5px; }
        .context-menu-item:hover .context-submenu { display: block; }

        /* --- 多选 --- */
        .multi-select-toolbar { position: fixed; bottom: 0; left: 0; right: 0; height: 50px; background: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); display: none; justify-content: space-around; align-items: center; z-index: 1002; }
        .multi-select-toolbar.active { display: flex; }
        .multi-select-toolbar button { background: none; border: none; font-size: 16px; color: var(--wechat-text-primary); cursor: pointer; }
        .multi-select-toolbar button:disabled { color: var(--wechat-text-secondary); cursor: not-allowed; }
        .message-row.multi-select-mode .message-body::before { content: ''; display: block; width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 50%; margin-right: 10px; align-self: center; flex-shrink: 0; }
        .message-row.multi-select-mode.selected .message-body::before { background-color: var(--wechat-green); border-color: var(--wechat-green); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='white' d='M12.207 4.793a1 1 0 0 1 0 1.414l-5 5a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L6.5 9.086l4.293-4.293a1 1 0 0 1 1.414 0z'/%3e%3c/svg%3e"); background-position: center; background-repeat: no-repeat; }
        .message-row.sent.multi-select-mode .message-body { flex-direction: row; } /* 修正多选框位置 */
        .message-row.sent.multi-select-mode .message-body::before { margin-left: 10px; margin-right: 0; order: 2; }
        .message-row.sent.multi-select-mode .message-body .message-avatar-wrapper { order: 3; }
        .message-row.sent.multi-select-mode .message-body .message-content-wrapper { order: 1; }

        /* --- 表单和模态框 --- */
        .form-page .content-area { padding: 15px; background-color: var(--wechat-bg); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: calc(var(--font-size-base) - 1px); color: var(--wechat-text-secondary); }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 8px; 
            font-size: var(--font-size-base); box-sizing: border-box; background: var(--wechat-nav-bg); color: var(--wechat-text-primary); 
        }
        .form-group textarea { min-height: 200px; resize: vertical; }
        .form-btn { display: block; width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 17px; font-weight: 500; cursor: pointer; background-color: var(--wechat-green); color: white; text-align: center; margin-top: 20px; }
        .file-input { display: none; }
        .avatar-upload-preview { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; cursor: pointer; display: block; margin: 0 auto 20px; border: 1px solid var(--wechat-border-color); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--wechat-nav-bg); padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color: var(--wechat-text-primary); }
        .modal-title { font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .modal-input-group { margin-bottom: 15px; }
        .modal-input-group label { font-size: calc(var(--font-size-base) - 1px); color: var(--wechat-text-secondary); }
        .modal-input { width: 100%; padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 6px; box-sizing: border-box; font-size: var(--font-size-base); background: var(--wechat-bg); color: var(--wechat-text-primary); }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid var(--wechat-border-color); background: var(--wechat-bg); cursor: pointer; font-size: var(--font-size-base); color: var(--wechat-text-primary); }
        .modal-btn.primary { background: var(--wechat-green); color: #fff; border-color: var(--wechat-green); }

        /* --- [优化] 钱包页面 --- */
        #wallet-page .content-area { background-color: var(--wechat-bg); padding: 0; }
        .wallet-header { background-color: #63B466; color: white; padding: 30px 20px; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        body.dark-mode .wallet-header { background-color: #2E7D32; }
        .wallet-balance-title { font-size: calc(var(--font-size-base) - 1px); opacity: 0.8; display: flex; align-items: center; gap: 10px; }
        .wallet-balance-title .currency-switcher { cursor: pointer; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; }
        .wallet-balance { font-size: calc(var(--font-size-base) + 25px); font-weight: bold; margin: 10px 0; word-break: break-all; }
        .wallet-services-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background-color: var(--wechat-border-color);
            margin: 20px;
            border-radius: 8px;
            overflow: hidden;
        }
        .wallet-service-item {
            background-color: var(--wechat-nav-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
            cursor: pointer;
            gap: 8px;
        }
        .wallet-service-item:active { background-color: var(--wechat-bg); }
        .walletnt-family: monospace; font-size: 12px; }
        .order-item .footer { padding: 10px; text-align: right; font-weight: bold; }

        /* [新增] 语音通话页面样式 */
        #voice-call-page {
            background-color: #333;
            color: white;
            z-index: 500;
        }
        .voice-call-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background-size: cover;
            background-position: center;
        }
        .voice-call-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
        }
        .voice-call-container > * { z-index: 1; }
        .voice-call-header { text-align: center; margin-bottom: 30px; }
        .voice-call-header .avatar { width: 100px; height: 100px; border-radius: var(--avatar-shape); margin-bottom: 15px; }
        .voice-call-header .name { font-size: 24px; font-weight: 500; }
        .voice-call-status { font-size: 16px; color: #ccc; margin-top: 10px; }
        .voice-call-chat-area {
            width: 90%;
            height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            font-size: 14px;
            line-height: 1.6;
        }
        .voice-call-chat-area p { margin: 0 0 5px; }
        .voice-call-input-bar {
            width: 90%;
            display: flex;
            gap: 10px;
        }
        .voice-call-input-bar input {
            flex: 1;
            padding: 12px;
            border-radius: 20px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .voice-call-controls {
            position: absolute;
            bottom: 40px;
            display: flex;
            gap: 40px;
        }
        .voice-call-controls .control-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .voice-call-controls .icon-wrapper {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
        }
        .voice-call-controls .hangup { background: var(--wechat-red); }
        .voice-call-controls .minimize { background: rgba(255,255,255,0.2); }
        .minimized-call-window {
            position: fixed;
            top: 60px;
            right: 15px;
            width: 210px; /* 420px / 2 */
            height: 130px; /* 260px / 2 */
            background: #333;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            color: white;
            cursor: pointer;
            padding: 10px;
            box-sizing: border-box;
        }
        .minimized-call-window .avatar { width: 40px; height: 40px; border-radius: 50%; }
        .minimized-call-window .status { font-size: 12px; }

        /* [新增] 银行卡页面样式 */
        .bank-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px;
            position: relative;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .bank-card .bank-name { font-size: 18px; font-weight: bold; }
        .bank-card .card-number { font-family: monospace; font-size: 20px; margin: 20px 0; letter-spacing: 2px; }
        .bank-card .card-balance { font-size: 16px; }
        .add-card-btn {
            border: 2px dashed var(--wechat-border-color);
            color: var(--wechat-text-secondary);
            text-align: center;
            padding: 40px 20px;
            margin: 15px;
            border-radius: 12px;
            cursor: pointer;
        }

        /* [新增] 公告栏页面样式 */
        #announcement-page .content-area { padding: 20px; line-height: 1.7; }
        #announcement-page h3 { color: var(--wechat-green); border-bottom: 1px solid var(--wechat-border-color); padding-bottom: 5px; }
        #announcement-page ul { padding-left: 20px; }

        /* 聊天气泡CSS注入点 */
        #user-bubble-style {}
        #user-voice-bubble-style {}
    </style>
</head>
<body>
    <!-- ▲▲▲ 防火墙HTML：激活弹窗 ▲▲▲ -->
    <div id="activation-overlay" style="display: none;">
        <div class="activation-modal">
            <div class="icon"><i class="fas fa-leaf"></i></div>
            <h2>Welcome to Lovely Phone</h2>
            <p>请输入激活码以唤醒您的专属世界</p>
            <input type="text" id="activation-code-input" placeholder="Activation Code">
            <button id="activation-submit-btn">激活</button>
        </div>
    </div>

    <div class="phone-container" id="phone-body">
        <div class="screen">
            <!-- 主页面容器 -->
            <div id="main-container" class="page active no-transition">
                <div class="wechat-header" id="main-header">
                    <div class="header-left">
                        <i class="fas fa-plus-circle" id="main-plus-btn"></i>
                    </div>
                    <span class="header-title">微信</span>
                    <div class="header-right">
                        <!-- 搜索图标已根据要求删除 -->
                    </div>
                </div>
                <div class="content-area" id="main-content-area"></div>
                <div class="wechat-tabbar">
                    <div class="tab-item active" data-page="chat-list">
                        <i class="fas fa-comment-dots"></i>
                        <span>聊天</span>
                    </div>
                    <div class="tab-item" data-page="contacts">
                        <i class="fas fa-address-book"></i>
                        <span>通讯录</span>
                    </div>
                    <div class="tab-item" data-page="me">
                        <i class="fas fa-user"></i>
                        <span>我</span>
                    </div>
                </div>
            </div>

            <!-- 页面容器 -->
            <div id="conversation-page" class="page sub-page"></div>
            <div id="editor-page" class="page sub-page form-page"></div>
            <div id="wallet-page" class="page sub-page"></div>
            <div id="transactions-page" class="page sub-page"></div>
            <div id="settings-page" class="page sub-page"></div>
            <div id="worldbook-page" class="page sub-page"></div>
            <div id="beautify-page" class="page sub-page"></div>
            <div id="frame-settings-page" class="page sub-page"></div>
            <div id="bubble-settings-page" class="page sub-page form-page"></div>
            <div id="api-settings-page" class="page sub-page form-page"></div>
            <div id="sticker-page" class="page sub-page"></div>
            <div id="moments-page" class="page sub-page"></div>
            <div id="create-moment-page" class="page sub-page form-page"></div>
            <div id="chat-settings-page" class="page sub-page"></div>
            <div id="blacklist-page" class="page sub-page"></div>
            <div id="data-management-page" class="page sub-page"></div>
            <div id="create-group-chat-page" class="page sub-page"></div>
            <div id="group-chat-settings-page" class="page sub-page"></div>
            <div id="group-member-management-page" class="page sub-page"></div>
            <div id="music-player-page" class="page sub-page"></div>
            <div id="music-library-page" class="page sub-page"></div>
            <div id="music-settings-page" class="page sub-page"></div>
            <div id="player-beautify-page" class="page sub-page"></div>
            <div id="chat-mode-page" class="page sub-page"></div>
            <div id="font-settings-page" class="page sub-page form-page"></div>
            <div id="timestamp-settings-page" class="page sub-page"></div>
            <div id="background-interaction-page" class="page sub-page"></div>
            <div id="theme-settings-page" class="page sub-page"></div>
            <div id="phone-frame-settings-page" class="page sub-page"></div>
            <div id="avatar-shape-settings-page" class="page sub-page"></div>
            <div id="screen-size-settings-page" class="page sub-page form-page"></div>
            <div id="long-term-memory-page" class="page sub-page"></div>
            <div id="poke-settings-page" class="page sub-page form-page"></div>
            <div id="diary-page" class="page sub-page"></div>
            <div id="self-persona-list-page" class="page sub-page"></div>
            <div id="self-persona-editor-page" class="page sub-page form-page"></div>
            <div id="language-settings-page" class="page sub-page"></div>
            <div id="storage-settings-page" class="page sub-page"></div>
            <div id="notification-settings-page" class="page sub-page form-page"></div>
            <div id="voice-call-page" class="page sub-page"></div>
            <!-- [新增] 新功能页面 -->
            <div id="global-theme-editor-page" class="page sub-page form-page"></div>
            <div id="bank-card-page" class="page sub-page"></div>
            <div id="char-balance-page" class="page sub-page"></div>
            <div id="announcement-page" class="page sub-page"></div>

            <!-- 模态框容器 -->
            <div id="modal-container"></div>
            
            <!-- 消息上下文菜单 -->
            <div class="message-context-menu" id="message-context-menu"></div>

            <!-- [新增            if (appData.settings.beautify.activeGlobalThemeSlot === undefined) appData.settings.beautify.activeGlobalThemeSlot = -1;
                if (!appData.user.nickname) { appData.user.nickname = appData.user.name || ' '; delete appData.user.name; }
                if (appData.user.persona) delete appData.user.persona;
                if (appData.user.address === undefined) appData.user.address = '';
                if (!appData.user.wallet) appData.user.wallet = JSON.parse(JSON.stringify(defaultAppData.user.wallet));
                if (!appData.user.wallet.currency) appData.user.wallet.currency = 'CNY';
                if (!appData.settings.charLanguage) appData.settings.charLanguage = 'zh-CN';
                if (!appData.settings.notifications) appData.settings.notifications = JSON.parse(JSON.stringify(defaultAppData.settings.notifications));
                if (!appData.user.personas) appData.user.personas = [];
                if (!appData.delivery) appData.delivery = JSON.parse(JSON.stringify(defaultAppData.delivery));
                if (!appData.settings.beautify.phoneFrame) appData.settings.beautify.phoneFrame = 'black';
                if (!appData.settings.beautify.avatarShape) appData.settings.beautify.avatarShape = 'rounded';
                if (!appData.settings.beautify.voiceBubbleCss) appData.settings.beautify.voiceBubbleCss = defaultAppData.settings.beautify.voiceBubbleCss;
                if (!appData.settings.beautify.screenWidth) appData.settings.beautify.screenWidth = 380;
                if (!appData.settings.beautify.screenHeight) appData.settings.beautify.screenHeight = 690;
                if (!appData.worldbooks) appData.worldbooks = { presets: [], styles: [], library: [] };
                if (!appData.longTermMemory) appData.longTermMemory = {};
                if (!appData.settings.poke) appData.settings.poke = JSON.parse(JSON.stringify(defaultAppData.settings.poke));
                if (!appData.settings.beautify.bubbleArchives) appData.settings.beautify.bubbleArchives = [{}, {}, {}, {}, {}];
                if (!appData.settings.api.repetition_penalty) appData.settings.api.repetition_penalty = 0.69;
                if (!appData.settings.api.presets) appData.settings.api.presets = [];
                if (!appData.music) appData.music = JSON.parse(JSON.stringify(defaultAppData.music));
                if (!appData.music.playerImage) appData.music.playerImage = defaultAppData.music.playerImage;
                if (!appData.music.playerBackground) appData.music.playerBackground = defaultAppData.music.playerBackground;
                appData.contacts.forEach(c => {
                    if (c.isPinned === undefined) c.isPinned = false;
                    if (c.isStarred === undefined) c.isStarred = false;
                    if (c.lastMomentPostTime === undefined) c.lastMomentPostTime = 0;
                    if (c.boundPersonaId === undefined) c.boundPersonaId = null;
                    if (c.isCouple === undefined) c.isCouple = false;
                });

            } catch (error) {
                console.error("Failed to load data, using defaults.", error);
                appData = JSON.parse(JSON.stringify(defaultAppData));
            }
        }

        async function saveData(showAlert = false, callback = null) {
            try {
                await dataManager.saveData(DATA_KEY, appData);
                if (showAlert) {
                    alert('保存成功!');
                }
                if (callback) {
                    callback();
                }
            } catch (error) {
                console.error("Error saving data to IndexedDB:", error);
                alert(`▲▲▲ 防火墙警告：数据保存失败！\n错误: ${error.message}\n请检查浏览器权限或联系技术支持。`);
            }
        }

        // --- Navigation ---
        let pageHistory = ['main-container'];
        function showPage(pageId, renderFunc, ...args) {
            // ▲▲▲ 防火墙：页面渲染前检查 ▲▲▲
            const pageElement = document.getElementById(pageId);
            if (!pageElement) {
                console.error(`Firewall: Page with ID "${pageId}" not found.`);
                alert(`▲▲▲ 防火墙警告：页面渲染失败！\n找不到ID为 "${pageId}" 的页面。`);
                return;
            }
            if (typeof renderFunc !== 'function') {
                console.error(`Firewall: renderFunc for page "${pageId}" is not a function.`);
                alert(`▲▲▲ 防火墙警告：页面渲染失败！\n页面 "${pageId}" 的渲染函数无效。`);
                return;
            }

            if (pageHistory[pageHistory.length - 1] !== pageId) {
                pageHistory.push(pageId);
            }

            try {
                renderFunc(pageElement, ...args);
            } catch (error) {
                console.error(`Firewall: Error rendering page "${pageId}":`, error);
                pageElement.innerHTML = `<div class="wechat-header"><div class="header-left header-back-btn" onclick="goBack()">返回</div></div><div style="padding: 20px; color: red;">页面渲染时发生错误: ${error.message}</div>`;
            }
            
            const allPages = document.querySelectorAll('.page');
            allPages.forEach(p => p.classList.remove('active'));
            
            pageElement.classList.add('active');
        }

        function goBack() {
            if (pageHistory.length <= 1) return;
            const currentPageId = pageHistory.pop();
            const previousPageId = pageHistory[pageHistory.length - 1];
            
            const currentPageEl = document.getElementById(currentPageId);
            if (currentPageEl) {
                currentPageEl.classList.remove('active');
            }
            
            const previousPageEl = document.getElementById(previousPageId);
            if (previousPageEl) {
                previousPageEl.classList.add('active');
            }
            
            if (previousPageId === 'main-container') {
                const activeTab = document.querySelector('.tab-item.active');
                if (activeTab) {
                    renderMainContent(activeTab.dataset.page);
                }
            }
        }

        // --- Rendering Functions ---
        function renderMainContent(pageType) {
            const contentArea = document.getElementById('main-content-area');
            const header = document.getElementById('main-header');
            const plusBtn = document.getElementById('main-plus-btn');
            
            // ▲▲▲ 防火墙：确保核心元素存在 ▲▲▲
            if (!contentArea || !header || !plusBtn) {
                document.body.innerHTML = "<h1>严重错误：主界面UI缺失，请清理缓存后重试。</h1>";
                return;
            }

            contentArea.innerHTML = '';
            plusBtn.style.display = 'block';
            header.querySelector('.header-left').style.visibility = 'visible';

            switch (pageType) {
                case 'chat-list':
                    header.querySelector('.header-title').textContent = '微信';
                    renderChatListPage(contentArea);
                    plusBtn.onclick = () => showMainPlusMenu();
                    break;
                case 'contacts':
                    header.querySelector('.header-title').textContent = '通讯录';
                    renderContactsPage(contentArea);
                    plusBtn.onclick = () => showPage('editor-page', renderEditorPage, 'character');
                    break;
                case 'me':
                    header.querySelector('.header-title').textContent = '';
                    renderMePage(contentArea);
                    header.querySelector('.header-left').style.visibility = 'hidden';
                    break;
            }
        }

        function showMainPlusMenu() {
            const modalId = 'main-plus-menu-modal';
            const html = `
                <div class="modal-content">
                    <div class="list-view" style="background: transparent;">
                        <div class="list-item" onclick="showPage('create-group-chat-page', renderCreateGroupChatPage); closeModal('${modalId}');">
                            <i class="fas fa-users"></i><span style="margin-left: 10px;">发起群聊</span>
                        </div>
                        <div class="list-item" onclick="showPage('editor-page', renderEditorPage, 'character'); closeModal('${modalId}');">
                            <i class="fas fa-user-plus"></i><span style="margin-left: 10px;">添加朋友</span>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function renderChatListPage(container) {
            let html = '<div class="list-view">';
            const visibleContacts = appData.contacts.filter(c => !appData.settings.blacklist.includes(c.id));
            const allChats = [...visibleContacts.map(c => ({...c, type: 'individual'})), ...appData.groups.map(g => ({...g, type: 'group'}))];
            
            const sortedChats = [...allChats].sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                const lastMsgA = a.conversation?.[a.conversation.length - 1]?.timestamp || 0;
                const lastMsgB = b.conversation?.[b.conversation.length - 1]?.timestamp || 0;
                return lastMsgB - lastMsgA;
            });

            if (sortedChats.length === 0) {
                html += '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">暂无聊天，去通讯录添加一个角色吧</div>';
            } else {
                sortedChats.forEach(chat => {
                    const lastMessage = chat.conversation && chat.conversation.length > 0
                        ? chat.conversation[chat.conversation.length - 1]
                        : { type: 'text', content: {content: '...'}, timestamp: chat.id };
                    const time = new Date(lastMessage.timestamp);
                    const displayTime = time.toLocaleDateString() ts.push({
                            id: Date.now(), name: newName, avatar: newAvatar, persona: newPersona,
                            conversation: [], remark: '', isPinned: false, isStarred: false, lastMomentPostTime: 0,
                            boundPersonaId: null, isCouple: false
                        });
                    }
                }
                saveData(true, goBack);
            };
        }
        
        function renderConversationPage(container, chatId, chatType) {
            appData.activeChat.id = chatId;
            appData.activeChat.type = chatType;

            let chat;
            let displayName;
            if (chatType === 'group') {
                chat = appData.groups.find(g => g.id == chatId);
                // ▲▲▲ 防火墙：处理群聊不存在的情况 ▲▲▲
                if (!chat) {
                    alert("错误：找不到该群聊。");
                    goBack();
                    return;
                }
                displayName = `${chat.name} (${chat.members.length})`;
            } else {
                chat = appData.contacts.find(c => c.id == chatId);
                // ▲▲▲ 防火墙：处理联系人不存在的情况 ▲▲▲
                if (!chat) {
                    alert("错误：找不到该联系人。");
                    goBack();
                    return;
                }
                displayName = chat.remark || chat.name;
            }
            
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()">
                        <i class="fas fa-chevron-left"></i>
                    </div>
                    <span class="header-title">${displayName}</span>
                    <div class="header-right" onclick="showPage('${chatType === 'group' ? 'group-chat-settings-page' : 'chat-settings-page'}', ${chatType === 'group' ? 'renderGroupChatSettingsPage' : 'renderChatSettingsPage'}, '${chatId}')"><i class="fas fa-ellipsis-h"></i></div>
                </div>
                <div class="content-area" id="message-area">
                    <div class="chat-scroll-buttons">
                        <button class="scroll-btn" id="scroll-to-top-btn" onclick="document.getElementById('message-area').scrollTop = 0;"><i class="fas fa-arrow-up"></i></button>
                        <button class="scroll-btn" id="scroll-to-bottom-btn" onclick="document.getElementById('message-area').scrollTop = document.getElementById('message-area').scrollHeight;"><i class="fas fa-arrow-down"></i></button>
                    </div>
                </div>
                <div class="chat-input-bar">
                    <i class="fas fa-microphone" id="chat-voice-btn"></i>
                    <input type="text" id="chat-input" placeholder="发送消息">
                    <i class="far fa-grin" id="chat-sticker-btn"></i>
                    <i class="fas fa-plus-circle" id="chat-plus-btn"></i>
                </div>
                <div class="chat-plus-menu" id="chat-plus-menu">
                    <div class="plus-menu-item" id="plus-image-btn"><div class="icon"><i class="fas fa-image"></i></div><span>相册</span></div>
                    <div class="plus-menu-item" id="plus-camera-btn"><div class="icon"><i class="fas fa-camera"></i></div><span>拍摄</span></div>
                    <div class="plus-menu-item" id="plus-voice-call-btn"><div class="icon"><i class="fas fa-phone-alt"></i></div><span>语音通话</span></div>
                    <div class="plus-menu-item" id="plus-location-btn"><div class="icon"><i class="fas fa-map-marker-alt"></i></div><span>位置</span></div>
                    <div class="plus-menu-item" id="plus-redpacket-btn"><div class="icon" style="color: #E64340;"><i class="fas fa-envelope"></i></div><span>红包</span></div>
                    <div class="plus-menu-item" id="plus-transfer-btn"><div class="icon"><i class="fas fa-exchange-alt"></i></div><span>转账</span></div>
                    <div class="plus-menu-item" id="plus-music-btn"><div class="icon"><i class="fas fa-music"></i></div><span>一起听</span></div>
                    <div class="plus-menu-item" id="plus-code-btn"><div class="icon"><i class="fas fa-code"></i></div><span>代码片段</span></div>
                    <div class="plus-menu-item" id="plus-diary-btn"><div class="icon"><i class="fas fa-book-open"></i></div><span>对方日记</span></div>
                    <div class="plus-menu-item" id="plus-gift-btn"><div class="icon" style="color: #FFB347;"><i class="fas fa-gift"></i></div><span>礼物</span></div>
                    <div class="plus-menu-item" id="plus-couple-btn"><div class="icon" style="color: #FF69B4;"><i class="fas fa-heart"></i></div><span>情侣空间</span></div>
                    <div class="plus-menu-item" id="plus-delivery-btn"><div class="icon" style="color: #FFC107;"><i class="fas fa-utensils"></i></div><span>外卖</span></div>
                    <div class="plus-menu-item" onclick="showPage('char-balance-page', showCharBalancePage, '${chatId}')"><div class="icon"><i class="fas fa-search-dollar"></i></div><span>对方余额</span></div>
                </div>
                <div class="multi-select-toolbar" id="multi-select-toolbar">
                    <button id="multi-select-forward-btn" disabled>转发</button>
                    <button id="multi-select-delete-btn" disabled>删除</button>
                    <button id="multi-select-cancel-btn">取消</button>
                </div>
            `;
            
            renderMessages(chatId, chatType);

            const messageArea = document.getElementById('message-area');
            const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');
            messageArea.onscroll = () => {
                if (messageArea.scrollHeight - messageArea.scrollTop - messageArea.clientHeight > 200) {
                    scrollToBottomBtn.style.display = 'flex';
                } else {
                    scrollToBottomBtn.style.display = 'none';
                }
            };

            const input = document.getElementById('chat-input');
            input.onkeydown = (e) => {
                if (e.key === 'Enter' && input.value.trim() !== '') {
                    e.preventDefault();
                    const quotedMessageId = input.dataset.quotedMessageId;
                    sendMessage(chatId, chatType, { content: input.value.trim() }, 'text', quotedMessageId);
                    input.value = '';
                    input.placeholder = '发送消息';
                    delete input.dataset.quotedMessageId;
                }
            };
            
            document.getElementById('chat-plus-btn').onclick = () => {
                const menu = document.getElementById('chat-plus-menu');
                menu.style.display = menu.style.display === 'grid' ? 'none' : 'grid';
            };
            
            document.getElementById('chat-voice-btn').onclick = () => showVoiceInputModal(chatId, chatType);
            document.getElementById('plus-image-btn').onclick = () => document.getElementById('image-file-input-chat').click();
            container.insertAdjacentHTML('beforeend', '<input type="file" id="image-file-input-chat" class="file-input" accept="image/*">');
            document.getElementById('image-file-input-chat').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    sendMessage(chatId, chatType, { url: dataUrl, description: "用户发送了一张图片" }, 'image');
                });
            };
            document.getElementById('plus-camera-btn').onclick = () => showCameraSimModal(chatId, chatType);
            document.getElementById('plus-location-btn').onclick = () => showLocationInputModal(chatId, chatType);
            document.getElementById('plus-transfer-btn').onclick = () => showTransactionModal('transfer', chatId, chatType);
            document.getElementById('plus-redpacket-btn').onclick = () => showTransactionModal('redPacket', chatId, chatType);
            document.getElementById('chat-sticker-btn').onclick = () => showPage('sticker-page', renderStickerPage, false);
            document.getElementById('plus-music-btn').onclick = () => showPage('music-library-page', renderMusicLibraryPage);
            document.getElementById('plus-code-btn').onclick = () => showHtmlContentModal(chatId, chatType);
            document.getElementById('plus-diary-btn').onclick = () => showPage('diary-page', renderDiaryPage, chatId);
            document.getElementById('plus-gift-btn').onclick = () => openGiftShopModal(chatId, chatType);
            document.getElementById('plus-couple-btn').onclick = () => sendCoupleInvitation(chatId, chatType);
            document.getElementById('plus-delivery-btn').onclick = () => openDeliveryModal(chatId, chatType);
            document.getElementById('plus-voice-call-btn').onclick = () => startVoiceCall(chatId, chatType, 'user');

            // 多选功能
            const multiSelectToolbar = document.getElementById('multi-select-toolbar');
            const forwardBtn = document.getElementById('multi-select-forward-btn');
            const deleteBtn = document.getElementById('multi-select-delete-btn');
            const cancelBtn = document.getElementById('multi-select-cancel-btn');
            let multiSelectState = { active: false, selectedIds: new Set() };

            window.startMultiSelectMode = (messageId) => {
                multiSelectState.active = true;
                multiSelectState.selectedIds.add(messageId);
                multiSelectToolbar.classList.add('active');
                document.querySelector('.chat-input-bar').style.display = 'none';
                updateMultiSelectUI();
            };

            const updateMultiSelectUI = () => {
                document.querySelectorAll('.message-row').forEach(row => {
                    row.classList.add('multi-select-mode');
                    if (multiSelectState.selectedIds.has(parseInt(row.dataset.messageId))) {
                        row.classList.adClass = 'receipt-bubble'; break;
                case 'voice_call': bubbleContent = renderer.voiceCall(msg); bubbleClass = 'voice-call-bubble'; break;
                default: bubbleContent = `[不支持的消息类型: ${msg.type}]`;
            }

            if (msg.translatedText) additionalContent += `<div class="translated-text-bubble">${msg.translatedText}</div>`;
            if (appData.settings.timestampStyle === 'bubble-inside') {
                const timeString = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second: '2-digit'});
                bubbleContent += `<div class="message-timestamp-inside" style="text-align: ${isSent ? 'right' : 'left'};">${timeString}</div>`;
            }

            return `<div class="message-bubble ${bubbleClass}" ondblclick="showMessageContextMenu(event, ${msg.id}, '${appData.activeChat.id}', '${chatType}')" ${additionalAttributes}>${bubbleContent}</div>${additionalContent}`;
        }

        // ▲▲▲ 代码分离：发送方气泡渲染器集合 ▲▲▲
        const sentBubbleRenderers = {
            text: msg => {
                let quotedHtml = '';
                if (msg.quotedMessage) {
                    const chat = appData.activeChat.type === 'group' ? appData.groups.find(g => g.id == appData.activeChat.id) : appData.contacts.find(c => c.id == appData.activeChat.id);
                    let quotedSenderName = '未知';
                    if (chat) {
                        if (appData.activeChat.type === 'group') {
                            const quotedSender = chat.members.find(m => m.id == msg.quotedMessage.sender);
                            if (quotedSender) quotedSenderName = quotedSender.name;
                        } else {
                            quotedSenderName = msg.quotedMessage.sender === appData.user.id ? appData.user.nickname : (chat.remark || chat.name);
                        }
                    }
                    quotedHtml = `<div class="quoted-message"><p><strong>${quotedSenderName}:</strong> ${msg.quotedMessage.content.substring(0, 30)}...</p></div>`;
                }
                return `${quotedHtml}${msg.content.content}`;
            },
            image: msg => `<img src="${msg.content.url}" alt="image">`,
            sticker: msg => `<img src="${msg.content.url}" class="sticker-message" alt="sticker">`,
            voice: msg => `<div class="voice-bubble-content"><div class="waveform">${Array(10).fill('<div class="bar"></div>').join('')}</div> <span>${msg.content.duration}"</span></div>`,
            location: msg => `<div class="location-text-wrapper"><div class="location-text">${msg.content.location}</div></div><div class="map-placeholder"><i class="fas fa-map-marked-alt"></i></div>`,
            cameraSim: msg => `<img src="https://img.heliar.top/file/1764050688895_Image_1757235244080.jpg" class="sim-icon"><span class="sim-text">糟糕…图片被本喵吃了໒꒰ྀིㅇㅁㅇ꒱ྀི১</span>`,
            transfer: (msg, chatType) => {
                const chat = chatType === 'group' ? appData.groups.find(g => g.id == appData.activeChat.id) : null;
                const recipientName = chat ? (chat.members.find(m => m.id == msg.content.recipientId)?.name || '成员') : '对方';
                return `<div class="main"><i class="fas fa-exchange-alt icon"></i><div class="details"><span class="amount">¥${parseFloat(msg.content.amount).toFixed(2)}</span><span class="remark">已转账</span></div></div><div class="footer">转账给 ${recipientName}</div>`;
            },
            redPacket: msg => `<div class="main"><i class="fas fa-envelope icon"></i><div class="details"><span class="remark">${msg.content.remark}</span><span class="amount" style="font-size: 14px;">查看红包</span></div></div><div class="footer">微信红包</div>`,
            forward: msg => {
                const originalChat = appData.groups.find(g => g.id == msg.content.originalChatId) || appData.contacts.find(c => c.id == msg.content.originalChatId);
                let forwardTitle = '聊天记录';
                if (originalChat) {
                    if (msg.content.originalChatType === 'group') {
                        forwardTitle = `${originalChat.name}的聊天记录`;
                    } else {
                        const otherUser = msg.content.messages.find(m => m.sender !== appData.user.id)?.sender;
                        const otherContact = appData.contacts.find(c => c.id == otherUser);
                        const otherName = otherContact ? (otherContact.remark || otherContact.name) : '对方';
                        forwardTitle = `${otherName}和${appData.user.nickname}的聊天记录`;
                    }
                }
                return `<i class="fas fa-comment-alt"></i> <span>[${forwardTitle}]</span>`;
            },
            music: msg => `<img src="${msg.content.cover}" alt="cover"><div class="details"><div class="title">${msg.content.title}</div><div class="artist">${msg.content.artist}</div></div>`,
            htmlContent: msg => `<iframe srcdoc="${escapeSrcDoc(msg.content.code)}" class="html-content-iframe" sandbox="allow-scripts allow-same-origin"></iframe>`,
            gift: msg => `<i class="fas fa-gift icon"></i><div class="details"><div class="name">${msg.content.name}</div><div class="desc">${msg.content.desc}</div></div>`,
            coupleInvitation: msg => `<i class="fas fa-heartbeat icon"></i><div class="text">${appData.user.nickname} 想与你成为情侣</div>`,
            receipt: (msg, title, icon) => {
                const itemsHtml = msg.content.items.map(item => `<div class="item-row"><span>${item.name} x${item.quantity}</span><span>¥${(item.price * item.quantity).toFixed(2)}</span></div>`).join('');
                return `<div class="header"><i class="fas ${icon}"></i>${title}</div><div class="items">${itemsHtml}</div><div class="total"><span>总计</span><span>¥${msg.content.total.toFixed(2)}</span></div><div class="footer">订单已送达</div>`;
            },
            voiceCall: msg => `<i class="fas fa-phone-alt"></i> 语音通话 <span style="margin-left: 10px; color: var(--wechat-text-secondary);">${msg.content.duration}</span>`
        };

        // ▲▲▲ 代码分离：接收方气泡渲染器集合 ▲▲▲
        const receivedBubbleRenderers = {
            ...sentBubbleRenderers, // 继承大部分渲染逻辑
            transfer: (msg, chatType) => {
                let statusText = '请你确认收款';
                if (msg.content.status === 'claimed') statusText = '已收款';
                else if (msg.content.status === 'returned') statusText = '已退回';
                return `<div class="main"><i class="fas fa-exchange-alt icon"></i><div class="details"><span class="amount">¥${parseFloat(msg.content.amount).toFixed(2)}</span><span class="remark">${statusText}</span></div></div><div class="footer">微信转账</div>`;
            },
            redPacket: msg => {
                let packetStatus = msg.content.claimed.includes(appData.user.id) ? '已领取' : '点击领取红包';
                if (msg.content.claimed.length >= msg.content.count) packetStatus = '红包已被领完';
                return `<div class="main"><i class="fas fa-envelope icon"></i><div class="details"><span class="remark">${msg.content.remark}</span><span class="amount" style="font-size: 14px;">${packetStatus}</span></div></div><div class="footer">微信红包</div>`;
            },
            coupleInvitation: (msg, chatType) => {
                const chat = appData.contacts.find(c => c.id == appData.activeChat.id);
                const inviterName = chat ? (chat.remark || chat.name) : '对方';
                return `<i class="fas fa-heartbeat icon"></i><div class="text">${inviterName} 想与你成为情侣</div><div class="actions"><button class="accept-btn" onclick="respondToCoupleInvitation(${msg.id}, true, '${appData.activeChat.id}', '${chatType}')">同意</button><button onclick="respondToCoupleInvitation(${msg.id}, false, '${appData.activeChat.id}', '${chatType}')">拒绝</button></div>`;
            }
        };
        
        function renderWalletPage(container) {
            const wallet = appData.user.wallet;
            const currentCurrency = wallet.currency;

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>我</span></div>
                    <span class="header-title">钱包</span>
                    <div class="header-right" style="font-size: 16px;" onclick="showPage('transactions-page', renderTransactionsPage)">账单</div>
                </div>
                <div class="content-area">
                    <div class="wallet-header">
                        <div class="wallet-balance-title">
                            <span>零钱 (${currentCurrency})</span>
                            <span class="currency-switcher" onclick="showCurrencySelectionModal()"><i class="fas fa-exchange-alt"></i> 切换</span>
                        </div>
                        <div class="wallet-balance">${formatCurrency(wallet.balance, currentCurrency)}</div>
                    </div>
                    <div class="wallet-services-grid">
                        <div class="wallet-service-item" onclick="alert('功能开发中...')">
                            <i class="fas fa-qrcode" style="color: var(--wechat-green);"></i>
                            <p>收付款</p>
                        </div>
                        <div class="wallet-service-item" onclick="showTransactionModal('deposit')">
                            <i class="fas fa-plus-circle" style="color: #FCAE3D;"></i>
                            <p>充值</p>
                        </div>
                        <div class="wallet-service-item" onclick="showTransactionModal('withdraw')">
                            <i class="fas fa-arrow-circle-down" style="color: #576B95;"></i>
                            <p>提现</p>
                        </div>
                        <div class="wallet-service-item" onclick="showPage('bank-card-page', renderBankCardPage)">
                            <i class="fas fa-credit-card" style="color: #576B95;"></i>
           s="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setTimestampStyle('center')">
                        <div class="details"><span class="name">时间戳居中 (每5分钟)</span></div>
                        ${appData.settings.timestampStyle === 'center' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTimestampStyle('bubble-outside')">
                        <div class="details"><span class="name">时间戳在气泡外</span></div>
                        ${appData.settings.timestampStyle === 'bubble-outside' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTimestampStyle('avatar-under')">
                        <div class="details"><span class="name">时间戳在头像下</span></div>
                        ${appData.settings.timestampStyle === 'avatar-under' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTimestampStyle('bubble-inside')">
                        <div class="details"><span class="name">时间戳在气泡内</span></div>
                        ${appData.settings.timestampStyle === 'bubble-inside' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setTimestampStyle(style) {
            appData.settings.timestampStyle = style;
            saveData();
            renderTimestampSettingsPage(document.getElementById('timestamp-settings-page'));
        }

        function renderBackgroundInteractionPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">后台互动</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item">
                        <div class="details"><span class="name">开启后台互动</span></div>
                        <label class="switch"><input type="checkbox" id="bg-interaction-toggle" ${appData.settings.backgroundInteraction.enabled ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-item" onclick="showBgInteractionIntervalModal()">
                        <div class="details"><span class="name">互动间隔</span></div>
                        <span class="info">${appData.settings.backgroundInteraction.interval / 60000} 分钟</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showBgInteractionCharSelectionModal()">
                        <div class="details"><span class="name">选择互动角色</span></div>
                        <span class="info">${appData.settings.backgroundInteraction.selectedChars.length} 个</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
            document.getElementById('bg-interaction-toggle').onchange = (e) => {
                appData.settings.backgroundInteraction.enabled = e.target.checked;
                saveData();
                renderBackgroundInteractionPage(document.getElementById('background-interaction-page'));
                if (e.target.checked) startBackgroundInteraction();
                else stopBackgroundInteraction();
            };
        }

        function showBgInteractionIntervalModal() {
            const modalId = 'bg-interaction-interval-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">设置互动间隔 (分钟)</div>
                    <div class="modal-input-group">
                        <input type="number" id="bg-interaction-interval-input" class="modal-input" value="${appData.settings.backgroundInteraction.interval / 60000}" min="1">
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="save-bg-interval-btn">保存</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('save-bg-interval-btn').onclick = () => {
                const intervalMinutes = parseInt(document.getElementById('bg-interaction-interval-input').value);
                if (isNaN(intervalMinutes) || intervalMinutes < 1) { alert('请输入有效的时间间隔'); return; }
                appData.settings.backgroundInteraction.interval = intervalMinutes * 60000;
                saveData();
                renderBackgroundInteractionPage(document.getElementById('background-interaction-page'));
                closeModal(modalId);
                if (appData.settings.backgroundInteraction.enabled) {
                    stopBackgroundInteraction();
                    startBackgroundInteraction();
                }
            };
        }

        function showBgInteractionCharSelectionModal() {
            const modalId = 'bg-interaction-char-selection-modal';
            const contactsHtml = appData.contacts.map(c => `
                <div class="list-item">
                    <img src="${c.avatar}" class="avatar" style="width: 36px; height: 36px;">
                    <div class="details"><span class="name">${c.remark || c.name}</span></div>
                    <input type="checkbox" data-contact-id="${c.id}" ${appData.settings.backgroundInteraction.selectedChars.includes(c.id) ? 'checked' : ''}>
                </div>
            `).join('');

            const html = `
                <div class="modal-content" style="max-width: 90%; width: 350px;">
                    <div class="modal-title">选择互动角色</div>
                    <div class="list-view contact-selection-list" style="max-height: 300px; overflow-y: auto; background: transparent;">
                        ${contactsHtml}
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="save-bg-chars-btn">保存</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('save-bg-chars-btn').onclick = () => {
                appData.settings.backgroundInteraction.selectedChars = Array.from(document.querySelectorAll('#' + modalId + ' input[type="checkbox"]:checked')).map(cb => parseInt(cb.dataset.contactId));
                saveData();
                renderBackgroundInteractionPage(document.getElementById('background-interaction-page'));
                closeModal(modalId);
                if (appData.settings.backgroundInteraction.enabled) {
                    stopBackgroundInteraction();
                    startBackgroundInteraction();
                }
            };
        }

        let backgroundInteractionTimer;
        function startBackgroundInteraction() {
            stopBackgroundInteraction();
            if (!appData.settings.backgroundInteraction.enabled || appData.settings.backgroundInteraction.selectedChars.length === 0) return;

            backgroundInteractionTimer = setInterval(async () => {
                const randomCharId = appData.settings.backgroundInteraction.selectedChars[Math.floor(Math.random() * appData.settings.backgroundInteraction.selectedChars.length)];
                const char = appData.contacts.find(c => c.id === randomCharId);
                if (char) {
                    const prompt = `你正在后台与'${appData.user.nickname}'进行互动。请你主动给'${appData.user.nickname}'发一条消息，内容可以是问候、分享日常、表达心情等，字数在20-100字之间，去除人机油腻，禁止带任何动作描述和括号描写。`;
                    const replies = await getAiReply(char.id, prompt);
                    const chatEntry = appData.contacts.find(c => c.id === char.id);
                    if (chatEntry) {
                        if (!chatEntry.conversation) chatEntry.conversation = [];
                        for (const reply of replies) {
                            await processAndSendAiReply(reply, char.id, 'individual', char.id);
                        }
                        if (appData.activeChat.id === char.id) {
                            renderMessages(char.id, 'individual');
                        }
                    }
                }
            }, appData.settings.backgroundInteraction.interval);
        }

        function stopBackgroundInteraction() {
            if (backgroundInteractionTimer) {
                clearInterval(backgroundInteractionTimer);
                backgroundInteractionTimer = null;
            }
        }
        
        function renderWorldbookPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">世界书</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showWorldbookEditor('presets')">
                        <div class="details"><span class="name">预设</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showWorldbookEditor('styles')">
                        <div class="details"><span class="name">文风</></div>
                        ${appData.settings.beautify.theme === 'transparent' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('neumorphic')">
                        <div class="details"><span class="name">ᦲ ᆺ ᦲ</span></div>
                        ${appData.settings.beautify.theme === 'neumorphic' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setTheme(theme) {
            appData.settings.beautify.theme = theme;
            saveData();
            applyBeautifySettings();
            renderThemeSettingsPage(document.getElementById('theme-settings-page'));
        }

        function renderScreenSizeSettingsPage(container) {
            const b = appData.settings.beautify;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">屏幕尺寸</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>屏幕宽度 (px)</label>
                        <input type="number" id="screen-width-input" value="${b.screenWidth}">
                    </div>
                    <div class="form-group">
                        <label>屏幕高度 (px)</label>
                        <input type="number" id="screen-height-input" value="${b.screenHeight}">
                    </div>
                    <button class="form-btn" id="save-screen-size-btn">应用</button>
                </div>
            `;
            document.getElementById('save-screen-size-btn').onclick = () => {
                b.screenWidth = parseInt(document.getElementById('screen-width-input').value);
                b.screenHeight = parseInt(document.getElementById('screen-height-input').value);
                saveData(true);
                applyBeautifySettings();
            };
        }

        function renderPhoneFrameSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">手机边框</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    ${['white', 'black', 'simple-white', 'pink', 'aqua-blue', 'semi-transparent', 'transparent', 'stereo'].map(frame => `
                    <div class="list-item" onclick="setPhoneFrame('${frame}')">
                        <div class="details"><span class="name">${{
                            white:'白色', 
                            black:'黑色', 
                            'simple-white':'简约白', 
                            pink:'樱花粉', 
                            'aqua-blue':'水蓝色', 
                            'semi-transparent':'半透明', 
                            transparent:'透明', 
                            stereo:'增强立体'
                        }[frame]}</span></div>
                        ${appData.settings.beautify.phoneFrame === frame ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>`).join('')}
                </div>
            `;
        }

        function setPhoneFrame(frame) {
            appData.settings.beautify.phoneFrame = frame;
            saveData();
            applyBeautifySettings();
            renderPhoneFrameSettingsPage(document.getElementById('phone-frame-settings-page'));
        }

        function renderAvatarShapeSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">头像形状</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setAvatarShape('rounded')">
                        <div class="details"><span class="name">圆角</span></div>
                        ${appData.settings.beautify.avatarShape === 'rounded' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setAvatarShape('circle')">
                        <div class="details"><span class="name">圆形</span></div>
                        ${appData.settings.beautify.avatarShape === 'circle' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setAvatarShape(shape) {
            appData.settings.beautify.avatarShape = shape;
            saveData();
            applyBeautifySettings();
            renderAvatarShapeSettingsPage(document.getElementById('avatar-shape-settings-page'));
        }

        function renderFontSettingsPage(container) {
            const b = appData.settings.beautify;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">更换字体</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>字体大小: <span id="font-size-value">${b.fontSize}</span>px</label>
                        <input type="range" id="font-size-input" min="10" max="30" value="${b.fontSize}" oninput="document.getElementById('font-size-value').textContent = this.value; document.getElementById('font-preview').style.fontSize = this.value + 'px';">
                    </div>
                    <div class="form-group">
                        <label>导入字体 (URL)</label>
                        <input type="text" id="font-url-input" placeholder="输入 .css, .ttf, .woff, .woff2 链接..." value="${b.fontUrl || ''}">
                    </div>
                    <div class="form-group">
                        <label>导入字体 (文件)</label>
                        <button class="form-btn" style="background-color: #aaa;" onclick="document.getElementById('font-file-input').click()">选择 .ttf, .woff, .woff2 文件</button>
                        <input type="file" id="font-file-input" class="file-input" accept=".ttf,.woff,.woff2">
                    </div>
                    <div class="form-group">
                        <label>字体预览</label>
                        <p id="font-preview" style="font-size:${b.fontSize}px; padding: 20px; background: var(--wechat-nav-bg); border-radius: 8px; text-align: center;">Hello, World. 你好，世界。</p>
                    </div>
                    <button class="form-btn" id="save-font-btn">保存并应用</button>
                </div>
            `;

            document.getElementById('save-font-btn').onclick = () => {
                const url = document.getElementById('font-url-input').value.trim();
                const fileInput = document.getElementById('font-file-input');
                const file = fileInput.files[0];
                const fontSize = parseInt(document.getElementById('font-size-input').value);

                appData.settings.beautify.fontSize = fontSize;

                const applyAndSave = () => {
                    saveData(true);
                    applyBeautifySettings();
                };

                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        appData.settings.beautify.fontFile = e.target.result;
                        appData.settings.beautify.fontUrl = ''; // Clear URL if file is chosen
                        applyAndSave();
                    };
                    reader.readAsDataURL(file);
                } else {
                    appData.settings.beautify.fontUrl = url;
                    appData.settings.beautify.fontFile = null; // Clear file if URL is chosen
                    applyAndSave();
                }
            };
        }

        function renderFrameSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">更换头像框</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showFrameEditor('user')">
                        <div class="details"><span class="name">更换我的头像框</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showFrameEditor('char')">
                        <div class="details"><span class="name">更换对方的头像框</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }
        
        function showFrameEditor(type) {
            const title = type === 'user' ? '更换我的头像框' : '更换对方的头像框';
            const currentFrame = type === 'user' ? appData.settings.beautify.userAvatarFrame : appData.settings.beautify.charAvatarFrame;
            const modalId = 'frame-editor-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">${title}</div>
 ion_penalty}</span></label>
                        <input type="range" id="repetition-penalty" min="-0.2" max="2" step="0.01" value="${api.repetition_penalty}" oninput="document.getElementById('penalty-value').textContent = this.value">
                    </div>
                    <button class="form-btn" id="save-api-btn">保存设置</button>
                </div>
            `;

            document.getElementById('api-preset-select').onchange = (e) => {
                const index = e.target.value;
                if (index > -1) {
                    const preset = appData.settings.api.presets[index];
                    document.getElementById('api-provider').value = preset.provider;
                    document.getElementById('api-endpoint').value = preset.endpoint;
                    document.getElementById('api-key').value = preset.key;
                    document.getElementById('api-model').value = preset.model;
                    document.getElementById('temperature').value = preset.temperature;
                    document.getElementById('top-p').value = preset.top_p;
                    document.getElementById('repetition-penalty').value = preset.repetition_penalty;
                    document.getElementById('temp-value').textContent = preset.temperature;
                    document.getElementById('topp-value').textContent = preset.top_p;
                    document.getElementById('penalty-value').textContent = preset.repetition_penalty;
                }
            };

            document.getElementById('save-preset-btn').onclick = () => {
                const presetName = prompt("请输入预设名称:");
                if (presetName) {
                    const newPreset = {
                        name: presetName,
                        provider: document.getElementById('api-provider').value,
                        endpoint: document.getElementById('api-endpoint').value.trim(),
                        key: document.getElementById('api-key').value.trim(),
                        model: document.getElementById('api-model').value.trim(),
                        temperature: parseFloat(document.getElementById('temperature').value),
                        top_p: parseFloat(document.getElementById('top-p').value),
                        repetition_penalty: parseFloat(document.getElementById('repetition-penalty').value)
                    };
                    appData.settings.api.presets.push(newPreset);
                    saveData(true, () => renderApiSettingsPage(container));
                }
            };

            document.getElementById('fetch-models-btn').onclick = fetchModels;
            document.getElementById('save-api-btn').onclick = () => {
                appData.settings.api.provider = document.getElementById('api-provider').value;
                appData.settings.api.endpoint = document.getElementById('api-endpoint').value.trim();
                appData.settings.api.key = document.getElementById('api-key').value.trim();
                appData.settings.api.model = document.getElementById('api-model').value.trim();
                appData.settings.api.temperature = parseFloat(document.getElementById('temperature').value);
                appData.settings.api.top_p = parseFloat(document.getElementById('top-p').value);
                appData.settings.api.repetition_penalty = parseFloat(document.getElementById('repetition-penalty').value);
                saveData(true);
            };
        }

        function renderStickerPage(container, isManagement = false) {
            let headerHtml = isManagement ? `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>我</span></div>
                    <span class="header-title">我的表情</span>
                    <div class="header-right" onclick="showStickerImportModal()"><i class="fas fa-plus"></i></div>
                </div>
            ` : `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">选择表情</span>
                </div>
            `;

            let bodyHtml = '';
            if (appData.stickers.packs.length === 0) {
                bodyHtml = '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">还没有表情包，快去添加吧</div>';
            } else {
                appData.stickers.packs.forEach(pack => {
                    bodyHtml += `<div class="sticker-pack">
                        <div class="sticker-pack-title">${pack.name}</div>
                        <div class="sticker-grid">
                            ${pack.stickers.map(sticker => `
                                <div class="sticker-item" onclick="sendSticker('${sticker.url}')"><content>
                                    <img src="${sticker.url}" loading="lazy">
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                });
            }
            container.innerHTML = headerHtml + `<div class="content-area">${bodyHtml}</div>`;
        }

        // --- Modals ---
        function showModal(id, html, isLarge = false) {
            const container = document.getElementById('modal-container');
            const modal = document.createElement('div');
            modal.id = id;
            modal.className = 'modal-overlay';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            if (isLarge) {
                modalContent.style.width = '360px';
                modalContent.style.height = '560px';
                modalContent.style.maxWidth = '95%';
                modalContent.style.maxHeight = '90%';
                modalContent.style.padding = '0';
                modalContent.style.display = 'flex';
                modalContent.style.flexDirection = 'column';
            }
            modalContent.innerHTML = html;
            
            modal.appendChild(modalContent);
            modal.style.display = 'flex';
            container.appendChild(modal);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }

        function showTransactionModal(type, chatId, chatType) {
            const wallet = appData.user.wallet;
            const currentCurrency = wallet.currency;
            const rate = exchangeRates[currentCurrency].rate;

            const isFinancial = type === 'deposit' || type === 'withdraw';
            if (isFinancial && appData.user.bankCards.length === 0) {
                alert('请先绑定银行卡！');
                showPage('bank-card-page', renderBankCardPage);
                return;
            }

            const title = { deposit: '充值', withdraw: '提现', transfer: '转账', redPacket: '发红包' }[type];
            
            const amountLimitCNY = { withdraw: 50000000, transfer: 5000000, redPacket: 200 }[type];
            const amountLimitDisplay = amountLimitCNY ? (amountLimitCNY * rate).toFixed(2) : null;
            const placeholder = amountLimitDisplay ? `0.01 ~ ${amountLimitDisplay}` : `请输入金额 (${currentCurrency})`;

            const remarkNeeded = type === 'transfer' || type === 'redPacket';
            
            const modalId = 'transaction-modal';
            let memberSelectionHtml = '';
            let recipientCountInput = '';
            let bankCardSelectionHtml = '';

            if (isFinancial) {
                bankCardSelectionHtml = `
                    <div class="modal-input-group">
                        <label>选择银行卡</label>
                        <select id="tx-bank-card" class="modal-input">
                            ${appData.user.bankCards.map(card => `<option value="${card.id}">${card.bankName} (尾号${card.number.slice(-4)})</option>`).join('')}
                        </select>
                    </div>
                `;
            }

            if (chatType === 'group' && (type === 'transfer' || type === 'redPacket')) {
                const group = appData.groups.find(g => g.id == chatId);
                const members = group.members.filter(m => m.id !== appData.user.id);
                if (type === 'transfer') {
                    memberSelectionHtml = `
                        <div class="modal-input-group">
                            <label>转账给</label>
                            <select id="tx-recipient" class="modal-input">
                                ${members.map(m => `<option value="${m.id}">转账给 ${m.name}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else if (type === 'redPacket') {
                    recipientCountInput = `
                        <div class="modal-input-group">
                            <label>红包个数</label>
                            <input type="number" id="redpacket-count" class="modal-input" value="1" min="1" max="${members.length}">
                        </div>
                    `;
                }
            }

            const html = `
                <div class="modal-content">
                    <div class="modal-title">${title}</div>
                    ${bankCardSelectionHtml}
                    ${memberSelectionHtml}
                    ${recipientCountInput}
                    <div class="modal-input-group">
                        <label>金额 (${currentCurrency})</label>
                        <input type="number" id="tx-amount" class="modal-input" placeholder="${placeholder}">
                    </div>
                    ${remarkNeeded ? `
                    <div class="modal-input-group">
                        <label>备注</label>
                        <input type="text" id="tx-remar.conversation = [];

            // ▲▲▲ 防火墙：禁言检查 ▲▲▲
            if (chatType === 'group') {
                const now = Date.now();
                const userMuteInfo = chat.mutedMembers[appData.user.id];
                const allMuted = chat.mutedMembers['all'];

                if ((userMuteInfo && userMuteInfo > now) || (allMuted && allMuted > now)) {
                    const muteUntil = new Date(userMuteInfo || allMuted);
                    const systemMsg = {
                        id: Date.now(), type: 'system',
                        content: { content: `你已被禁言，禁言至 ${muteUntil.toLocaleString()}` },
                        timestamp: now
                    };
                    chat.conversation.push(systemMsg);
                    renderMessages(chatId, chatType);
                    return;
                }
            }
            
            const message = {
                id: Date.now(), sender: appData.user.id, type, content,
                timestamp: Date.now(), isRecalled: false
            };

            if (quotedMessageId) {
                const quotedMsg = chat.conversation.find(m => m.id == quotedMessageId);
                if (quotedMsg) {
                    message.quotedMessage = {
                        id: quotedMsg.id, sender: quotedMsg.sender,
                        content: quotedMsg.type === 'text' ? quotedMsg.content.content : `[${quotedMsg.type}]`
                    };
                }
            }
            
            chat.conversation.push(message);
            playNotificationSound('send');
            saveData();
            renderMessages(chatId, chatType);
            
            // AI Reply Logic
            const shouldReply = ['text', 'image', 'camera-sim', 'location', 'voice', 'sticker', 'transfer', 'redPacket', 'music', 'html-content', 'gift', 'couple_invitation', 'delivery_receipt', 'gift_receipt'].includes(type);
            if (chatType === 'individual' && shouldReply) {
                setTypingIndicator(chatId, true);
                const replies = await getAiReply(chat.id);
                setTypingIndicator(chatId, false);
                for (const reply of replies) {
                    await processAndSendAiReply(reply, chat.id, 'individual', chat.id);
                }
            } else if (chatType === 'group' && shouldReply) {
                for (const member of chat.members) {
                    if (member.id != appData.user.id) {
                        setTypingIndicator(chatId, true, member.name);
                        const replies = await getAiReply(member.id, null, chat.id);
                        setTypingIndicator(chatId, false);
                        for (const reply of replies) {
                            await processAndSendAiReply(reply, chat.id, 'group', member.id);
                        }
                    }
                }
            }
        }

        async function processAndSendAiReply(replyText, chatId, chatType, senderId) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            if (!chat) return;

            const transferMatch = replyText.match(/\[transfer:\s*amount=([\d.]+),\s*remark=(.*?)\]/i);
            const redPacketMatch = replyText.match(/\[redPacket:\s*amount=([\d.]+),\s*remark=(.*?)\]/i);
            const stickerMatch = replyText.match(/\[sticker:(.+?)\]/i);
            const coupleInviteMatch = replyText.match(/\[couple_invitation\]/i);
            const voiceCallMatch = replyText.match(/\[voice_call\]/i);

            let message;
            if (transferMatch) {
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: 'transfer',
                    content: { amount: parseFloat(transferMatch[1]), remark: transferMatch[2], status: 'sent', recipientId: appData.user.id },
                    timestamp: Date.now()
                };
            } else if (redPacketMatch) {
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: 'redPacket',
                    content: { amount: parseFloat(redPacketMatch[1]), remark: redPacketMatch[2], count: 1, claimed: [], total: 1 },
                    timestamp: Date.now()
                };
            } else if (stickerMatch) {
                const packName = stickerMatch[1];
                const pack = appData.stickers.packs.find(p => p.name === packName);
                if (pack && pack.stickers.length > 0) {
                    const randomSticker = pack.stickers[Math.floor(Math.random() * pack.stickers.length)];
                    message = { id: Date.now() + Math.random(), sender: senderId, type: 'sticker', content: { url: randomSticker.url }, timestamp: Date.now() };
                }
            } else if (coupleInviteMatch) {
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: 'couple_invitation',
                    content: {}, timestamp: Date.now()
                };
            } else if (voiceCallMatch) {
                startVoiceCall(chatId, chatType, 'char');
                return;
            } else {
                message = { id: Date.now() + Math.random(), sender: senderId, type: 'text', content: { content: replyText }, timestamp: Date.now() };
            }

            if (message) {
                chat.conversation.push(message);
                playNotificationSound('receive');
                saveData();
                renderMessages(chatId, chatType);
            }
        }

        function sendSticker(url) {
            if (appData.activeChat.id) {
                sendMessage(appData.activeChat.id, appData.activeChat.type, { url }, 'sticker');
                goBack();
            }
        }

        let aiReplyController = null;
        async function getAiReply(senderId, customPrompt = null, groupId = null) {
            const contact = appData.contacts.find(c => c.id == senderId);
            // ▲▲▲ 防火墙：AI回复前检查 ▲▲▲
            if (!contact) {
                console.error(`Firewall: AI reply requested for non-existent contact ID ${senderId}.`);
                return ["(错误: 无法找到AI角色)"];
            }
            const { key, model } = appData.settings.api;
            if (!key || !model) {
                console.warn(`Firewall: API settings are incomplete. AI reply is disabled.`);
                return ["(提示: API未配置，AI无法回复)"];
            }

            let chatHistory = [];
            let lastMessage;

            if (groupId) {
                const group = appData.groups.find(g => g.id === groupId);
                if (group) {
                    chatHistory = group.conversation;
                    lastMessage = chatHistory[chatHistory.length - 1];
                    const mentionedMember = group.members.find(m => 
                        m.id != lastMessage.sender &&
                        lastMessage.type === 'text' &&
                        lastMessage.content.content.includes(m.remark || m.name)
                    );

                    if (mentionedMember && mentionedMember.id !== senderId) {
                        return []; // Not this AI's turn
                    }
                    if (!mentionedMember && Math.random() > 0.3) {
                        return []; // Randomly decide not to speak
                    }
                }
            } else {
                chatHistory = contact.conversation;
            }

            const boundPersonaId = contact.boundPersonaId;
            const userPersona = boundPersonaId ? appData.user.personas.find(p => p.id === boundPersonaId) : appData.user;
            const userPersonaPrompt = userPersona ? `\n\n【对话者'${userPersona.name}'的人设】\n${userPersona.description || ''}` : `\n\n【对话者'${appData.user.nickname}'的人设】\n无`;

            const relevantHistory = chatHistory
                .filter(m => m.type !== 'typing' && !m.isRecalled)
                .map(m => {
                    const role = m.sender === appData.user.id ? 'user' : 'assistant';
                    let contentText = '';
                    switch(m.type) {
                        case 'text': contentText = m.content.content; break;
                        case 'image': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发送了一张图片]`; break;
                        case 'camera-sim': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发送了一张图片，内容是: ${m.content.description}]`; break;
                        case 'sticker': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发送了一个表情]`; break;
                        case 'transfer': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发起了转账，金额: ${m.content.amount}]`; break;
                        case 'redPacket': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发了红包，金额: ${m.content.amount}]`; break;
                        case 'music': contentText = `[${m.sender === appData.user.id ? '我' : '你'}分享了音乐: ${m.content.title}]`; break;
                        case 'html-content': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发送了一个代码片段]`; break;
                        case 'gift': contentText = `[${m.sender === appData.user.id ? '我' : '你'}赠送了礼物: ${m.content.name}]`; break;
                        case 'couple_invitation': contentText = `[${m.sender === appData.user.id ? '我' : '你'}发起了情侣邀请]`; break;
                        case 'delivery_receipt': contentText = `[${m.sender === appData.user.id ? '我' : '你'}点了一份外卖]`; break;
                        case 'gift_receipt': contentText = `[${m.sender === appData.user.id ? '我' : '你'}购买了礼物]`; break;
                        case 'voice_call': contentText = `[语音通话，时长: ${m.content.duration}]`; break;
                        default: contentText = `[${m.sender === appData.user.id ? '我' : '你'}发送了一个${m.type}]`; break;
                    }
                    return { role, content: contentText };
                  const bubbleStyle = document.getElementById('user-bubble-style');
            const voiceBubbleStyle = document.getElementById('user-voice-bubble-style');
            const globalThemeStyle = document.getElementById('global-theme-style');
            const beautify = appData.settings.beautify;
            
            // Global Theme
            if (beautify.activeGlobalThemeSlot > -1 && beautify.globalThemeArchives[beautify.activeGlobalThemeSlot]) {
                globalThemeStyle.innerHTML = beautify.globalThemeArchives[beautify.activeGlobalThemeSlot].css;
            } else {
                globalThemeStyle.innerHTML = '';
            }

            // Screen Size
            root.style.setProperty('--phone-width', `${beautify.screenWidth}px`);
            root.style.setProperty('--phone-height', `${beautify.screenHeight}px`);

            // Theme
            document.body.className = ''; // Reset all theme classes
            if (beautify.theme) {
                document.body.classList.add(`${beautify.theme}-mode`);
            }

            // Phone Frame
            const frameStyles = {
                white: { color: '#E5E5E5', width: '10px', shadow: '0 10px 40px rgba(0,0,0,0.2)', highlight: 'transparent', backdrop: 'none' },
                black: { color: '#111', width: '10px', shadow: '0 15px 50px rgba(0,0,0,0.3)', highlight: 'transparent', backdrop: 'none' },
                'simple-white': { color: '#FFF', width: '10px', shadow: '0 10px 40px rgba(0,0,0,0.2)', highlight: '#111', backdrop: 'none' },
                pink: { color: '#FFC0CB', width: '10px', shadow: '0 10px 40px rgba(255,192,203,0.3)', highlight: 'transparent', backdrop: 'none' },
                'aqua-blue': { color: '#00FFFF', width: '10px', shadow: '0 10px 40px rgba(0, 255, 255, 0.3)', highlight: 'transparent', backdrop: 'none' },
                'semi-transparent': { color: 'rgba(255, 255, 255, 0.1)', width: '10px', shadow: '0 10px 40px rgba(0,0,0,0.2)', highlight: 'rgba(255, 255, 255, 0.2)', backdrop: 'blur(10px)' },
                transparent: { color: 'transparent', width: '0px', shadow: 'none', highlight: 'transparent', backdrop: 'none' },
                stereo: { color: '#111', width: '10px', shadow: '0 25px 60px rgba(0,0,0,0.5), inset 0 0 15px rgba(255,255,255,0.05)', highlight: '#fff', backdrop: 'none' }
            };
            const style = frameStyles[beautify.phoneFrame] || frameStyles.black;
            root.style.setProperty('--phone-border-color', style.color);
            root.style.setProperty('--phone-border-width', style.width);
            root.style.setProperty('--phone-shadow', style.shadow);
            root.style.setProperty('--phone-edge-highlight', style.highlight);
            root.style.setProperty('--phone-backdrop-filter', style.backdrop);

            // Chat Background
            root.style.setProperty('--chat-background-image', beautify.chatBackground ? `url(${beautify.chatBackground})` : 'none');

            // Font
            const defaultFontStyle = document.getElementById('default-font-style');
            if (beautify.fontFile || beautify.fontUrl) {
                if (defaultFontStyle) defaultFontStyle.remove();
                let fontSrc = beautify.fontFile ? `url(${beautify.fontFile})` : `url(${beautify.fontUrl})`;
                if (beautify.fontUrl && beautify.fontUrl.endsWith('.css')) {
                    let link = document.querySelector('link[href="' + beautify.fontUrl + '"]');
                    if (!link) {
                        link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = beautify.fontUrl;
                        document.head.appendChild(link);
                    }
                } else {
                    root.style.setProperty('--user-custom-font-src', fontSrc);
                }
            } else {
                if (!document.getElementById('default-font-style')) {
                    const style = document.createElement('style');
                    style.id = 'default-font-style';
                    style.innerHTML = `@font-face { font-family: 'UserCustomFont'; src: url('https://static.zeoseven.com/zsft/256/main/result.css'); }`;
                    document.head.appendChild(style);
                }
            }
            root.style.setProperty('--font-size-base', `${beautify.fontSize}px`);

            // Avatar Shape & Frames
            root.style.setProperty('--avatar-shape', beautify.avatarShape === 'circle' ? '50%' : '6px');
            root.style.setProperty('--user-avatar-frame', beautify.userAvatarFrame ? `url(${beautify.userAvatarFrame})` : 'none');
            root.style.setProperty('--char-avatar-frame', beautify.charAvatarFrame ? `url(${beautify.charAvatarFrame})` : 'none');
            
            // Bubble CSS
            bubbleStyle.innerHTML = beautify.bubbleCss || '';
            voiceBubbleStyle.innerHTML = beautify.voiceBubbleCss || '';

            // Music Player
            root.style.setProperty('--player-image', `url(${appData.music.playerImage})`);
            root.style.setProperty('--player-background', `url(${appData.music.playerBackground})`);
            
            // Notification Sounds
            document.getElementById('send-sound-player').src = appData.settings.notifications.send;
            document.getElementById('receive-sound-player').src = appData.settings.notifications.receive;
            document.getElementById('ringtone-player').src = appData.settings.notifications.ringtone;
        }

        function showMessageContextMenu(event, messageId, chatId, chatType) {
            event.preventDefault();
            const menu = document.getElementById('message-context-menu');
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const message = chat.conversation.find(m => m.id == messageId);
            if (!message || message.type === 'typing') return;

            let itemsHtml = `<div class="context-menu-item" onclick="handleMessageAction('edit', ${messageId}, '${chatId}', '${chatType}')">编辑</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('quote', ${messageId}, '${chatId}', '${chatType}')">引用</div>`;
            if (message.type === 'text' || message.type === 'voice') {
                const languages = {
                    'zh-CN': '简体中文', 'zh-TW': '繁体中文',
                    de:'德语',en:'英语',fr:'法语',ru:'俄语',pt:'葡萄牙语',yue:'粤语',ja:'日语',ko:'韩语',th:'泰语',it:'意大利语',fa:'波斯语',vi:'越南语'
                };
                let langSubmenu = '';
                for (const [code, name] of Object.entries(languages)) {
                    langSubmenu += `<div class="context-menu-item" onclick="handleMessageAction('translate', ${messageId}, '${chatId}', '${chatType}', { lang: '${code}', langName: '${name}' })">${name}</div>`;
                }
                itemsHtml += `<div class="context-menu-item">翻译 <div class="context-submenu">${langSubmenu}</div></div>`;
            }
            if (message.type === 'voice') itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('voiceToText', ${messageId}, '${chatId}', '${chatType}')">转文字</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('recall', ${messageId}, '${chatId}', '${chatType}')">撤回</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('delete', ${messageId}, '${chatId}', '${chatType}')">删除</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('forward', ${messageId}, '${chatId}', '${chatType}')">转发</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="startMultiSelectMode(${messageId})">多选</div>`;
            
            menu.innerHTML = itemsHtml;
            menu.style.display = 'block';
            
            const menuRect = menu.getBoundingClientRect();
            const bodyRect = document.body.getBoundingClientRect();
            let left = event.clientX;
            if (left + menuRect.width > bodyRect.width) left = event.clientX - menuRect.width;
            let top = event.clientY;
            if (top + menuRect.height > bodyRect.height) top = event.clientY - menuRect.height;
            
            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;

            const closeMenu = () => {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenu);
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }

        async function handleMessageAction(action, messageId, chatId, chatType, options = {}) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const messageIndex = chat.conversation.findIndex(m => m.id == messageId);
            if (messageIndex === -1) return;
            const message = chat.conversation[messageIndex];

            switch(action) {
                case 'edit':
                    const newContent = prompt('编辑消息内容:', message.content.content);
                    if (newContent !== null) message.content.content = newContent;
                    break;
                case 'quote':
                    const input = document.getElementById('chat-input');
                    input.focus();
                    input.dataset.quotedMessageId = messageId;
                    input.placeholder = '以引用的形式回复...';
                    break;
                case 'voiceToText':
                    if (message.transcribedText) delete message.transcribedText;
                    else message.transcribedText = `[转文字] ${message.content.text}`;
                    break;
                case 'translate':
                    if (message.translatedText) {
       ;">
                                <button onclick="addMomentComment(${post.id})" style="padding: 8px 12px; background: var(--wechat-green); color: white; border: none; border-radius: 4px;">发送</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            feedContainer.innerHTML = html;
        }
        
        function deleteMoment(postId) {
            if (confirm('确定要删除这条动态吗？')) {
                appData.moments = appData.moments.filter(p => p.id !== postId);
                saveData();
                renderMomentsFeed();
            }
        }

        function deleteMomentComment(postId, commentIndex) {
            if (confirm('确定要删除这条评论吗？')) {
                const post = appData.moments.find(p => p.id === postId);
                if (post) {
                    post.comments.splice(commentIndex, 1);
                    saveData();
                    renderMomentsFeed();
                }
            }
        }

        function showMomentCommentInput(postId, replyToName = null) {
            event.stopPropagation();
            const inputDiv = document.getElementById(`comment-input-${postId}`);
            if (inputDiv) {
                const input = inputDiv.querySelector('input');
                inputDiv.style.display = 'block';
                input.placeholder = replyToName ? `回复 ${replyToName}:` : '发表评论...';
                input.focus();
            }
        }

        function addMomentComment(postId) {
            const input = document.querySelector(`#comment-input-${postId} input`);
            const commentText = input.value.trim();
            if (!commentText) return;

            const post = appData.moments.find(p => p.id === postId);
            if (post) {
                post.comments.push({ authorId: appData.user.id, text: commentText, timestamp: Date.now() });
                saveData();
                renderMomentsFeed();
                
                const author = appData.contacts.find(c => c.id === post.authorId);
                if (author) {
                    const prompt = `'${appData.user.nickname}'在你的朋友圈下评论说：“${commentText}”。请你根据自己的角色设定进行回复，务必完全贴合人设，不要人机味不要太死板，话题务必要围着该动态和评论回复user，而非自顾自的自言自语，要熟知所有网络热梗语录。`;
                    getAiReply(author.id, prompt).then(replies => {
                        if (replies.length > 0) {
                            post.comments.push({ authorId: author.id, text: replies[0], timestamp: Date.now() });
                            saveData();
                            renderMomentsFeed();
                        }
                    });
                }
            }
        }

        function toggleMomentLike(postId, userId) {
            const post = appData.moments.find(p => p.id === postId);
            if (post) {
                const index = post.likes.indexOf(userId);
                if (index > -1) post.likes.splice(index, 1);
                else post.likes.push(userId);
                saveData();
                renderMomentsFeed();
            }
        }

        function renderCreateMomentPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()">取消</div>
                    <span class="header-title">发表朋友圈</span>
                    <div class="header-right" style="font-size: 16px; color: white; background: var(--wechat-green); padding: 5px 12px; border-radius: 4px;" id="post-moment-btn">发表</div>
                </div>
                <div class="content-area">
                    <textarea id="moment-text-input" maxlength="5000" placeholder="这一刻的想法..." style="width: 100%; height: 200px; border: none; padding: 15px; box-sizing: border-box; font-size: 16px; resize: none; background: transparent; color: var(--wechat-text-primary);"></textarea>
                    <div style="padding: 15px;">
                        <button onclick="document.getElementById('moment-media-input').click()" class="form-btn" style="margin-top: 0; margin-bottom: 10px; background: #f0f0f0; color: #333;">选择图片/视频/音频</button>
                        <input type="file" id="moment-media-input" class="file-input" accept="image/*,video/*,audio/*" multiple>
                        <div id="moment-media-preview" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showMomentVisibilityModal()">
                        <div class="details"><span class="name">谁可以看</span></div>
                        <span class="info" id="moment-visibility-info">全部可见</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;

            const mediaInput = document.getElementById('moment-media-input');
            const mediaPreview = document.getElementById('moment-media-preview');
            let selectedMedia = [];
            let momentVisibility = 'public';
            let visibleToContacts = [];

            mediaInput.onchange = (e) => {
                selectedMedia = [];
                mediaPreview.innerHTML = '';
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        selectedMedia.push({ type: file.type, url: event.target.result });
                        if (file.type.startsWith('image')) mediaPreview.innerHTML += `<img src="${event.target.result}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">`;
                        else if (file.type.startsWith('video')) mediaPreview.innerHTML += `<video src="${event.target.result}" controls style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;"></video>`;
                        else if (file.type.startsWith('audio')) mediaPreview.innerHTML += `<audio src="${event.target.result}" controls style="width: 100%;"></audio>`;
                    };
                    reader.readAsDataURL(file);
                });
            };

            window.showMomentVisibilityModal = () => {
                const modalId = 'moment-visibility-modal';
                const contactsHtml = appData.contacts.map(c => `
                    <div class="list-item">
                        <img src="${c.avatar}" class="avatar" style="width: 36px; height: 36px;">
                        <div class="details"><span class="name">${c.remark || c.name}</span></div>
                        <input type="checkbox" data-contact-id="${c.id}" ${visibleToContacts.includes(c.id) ? 'checked' : ''}>
                    </div>
                `).join('');

                const html = `
                    <div class="modal-content" style="max-width: 90%; width: 350px;">
                        <div class="modal-title">谁可以看</div>
                        <div class="list-view" style="background: transparent;">
                            <div class="list-item"><label style="width: 100%;"><input type="radio" name="visibility" value="public" ${momentVisibility === 'public' ? 'checked' : ''}> 全部可见</label></div>
                            <div class="list-item"><label style="width: 100%;"><input type="radio" name="visibility" value="private" ${momentVisibility === 'private' ? 'checked' : ''}> 仅自己可见</label></div>
                            <div class="list-item"><label style="width: 100%;"><input type="radio" name="visibility" value="selected" ${momentVisibility === 'selected' ? 'checked' : ''}> 指定人可见</label></div>
                        </div>
                        <div id="selected-contacts-list" style="max-height: 200px; overflow-y: auto; border-top: 1px solid #eee; margin-top: 10px; ${momentVisibility === 'selected' ? '' : 'display: none;'}">
                            ${contactsHtml}
                        </div>
                        <button class="modal-btn primary" id="save-visibility-btn" style="margin-top: 15px;">确定</button>
                    </div>
                `;
                showModal(modalId, html);

                document.querySelectorAll('input[name="visibility"]').forEach(radio => {
                    radio.onchange = (e) => {
                        momentVisibility = e.target.value;
                        document.getElementById('selected-contacts-list').style.display = momentVisibility === 'selected' ? 'block' : 'none';
                    };
                });

                document.getElementById('save-visibility-btn').onclick = () => {
                    if (momentVisibility === 'selected') {
                        visibleToContacts = Array.from(document.querySelectorAll('#selected-contacts-list input[type="checkbox"]:checked')).map(cb => parseInt(cb.dataset.contactId));
                        if (visibleToContacts.length === 0) { alert('请选择至少一个可见好友'); return; }
                    }
                    document.getElementById('moment-visibility-info').textContent = {
                        'public': '全部可见', 'private': '仅自己可见',
                        'selected': `指定${visibleToContacts.length}人可见`
                    }[momentVisibility];
                    closeModal(modalId);
                };
            };

            document.getElementById('post-moment-btn').onclick = async () => {
                const text = document.getElementById('moment-text-input').value.trim();
                if (!text && selectedMedia.length === 0) { alert('内容或媒体不能为空'); return; }

                const newPost = {
                    id: Date.now(), authorId: appData.user.id, text, media: selectedMedia,
                    timestamp: Date.now(), likes: [], comments: [],
                    visibility: momentVisibility, visibleTo: visibleToContacts
                };

                appData.moments.push(newPost);
                    container.innerHTML = html;
        }

        function unblockContact(contactId) {
            appData.settings.blacklist = appData.settings.blacklist.filter(id => id != contactId);
            saveData();
            renderBlacklist();
        }

        // --- Data Management ---
        function renderDataManagementPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">数据管理</span>
                </div>
                <div class="content-area" style="padding: 20px;">
                    <button class="form-btn" id="export-data-btn">备份数据到文件</button>
                    <button class="form-btn" style="background-color: #aaa; margin-top: 10px;" onclick="document.getElementById('import-data-input').click()">从文件恢复数据</button>
                    <input type="file" id="import-data-input" class="file-input" accept=".json">
                </div>
            `;
            document.getElementById('export-data-btn').onclick = exportData;
            document.getElementById('import-data-input').onchange = importData;
        }

        async function exportData() {
            try {
                const allData = await dataManager.exportAllData();
                const dataStr = JSON.stringify(allData);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `LovelyPhone热心提醒你一定要勤备份哦ㅇㅅㅇ_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                alert(`▲▲▲ 防火墙警告：数据导出失败！\n${error.message}`);
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm('恢复数据将覆盖当前所有内容，确定要继续吗？')) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // ▲▲▲ 防火墙：导入数据结构验证 ▲▲▲
                    if (importedData.appData && importedData.appData.user && importedData.appData.contacts) {
                        await dataManager.importFromBackup(importedData);
                        alert('数据恢复成功！应用将重新加载。');
                        location.reload();
                    } else {
                        throw new Error('文件格式不正确或数据结构不完整。');
                    }
                } catch (err) {
                    alert(`▲▲▲ 防火墙警告：数据恢复失败！\n${err.message}`);
                }
            };
            reader.readAsText(file);
        }
        
        function handleBubbleClick(type, msgId, chatId, chatType) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const message = chat.conversation.find(m => m.id == msgId);
            if (!message) return;

            if (type === 'camera-sim') {
                alert(`图片内容：\n\n${message.content.description}`);
            } else if (type === 'redPacket' && message.sender !== appData.user.id) {
                if (message.content.claimed.includes(appData.user.id)) { alert('你已经领取过该红包了。'); return; }
                if (message.content.claimed.length >= message.content.count) { alert('该红包已被领完。'); return; }

                if (confirm('是否领取红包？')) {
                    const amountPerPerson = message.content.amount / message.content.count;
                    appData.user.wallet.balance += amountPerPerson;
                    const senderName = chatType === 'group' ? (chat.members.find(m => m.id === message.sender)?.name || '群成员') : (chat.remark || chat.name);
                    appData.user.wallet.transactions.push({ type: '红包', amount: amountPerPerson, details: `收到${senderName}的红包`, timestamp: Date.now() });
                    
                    message.content.claimed.push(appData.user.id);
                    
                    const systemMsg = {
                        id: Date.now(), type: 'system',
                        content: { content: `${appData.user.nickname} 领取了 ${senderName} 的红包` },
                        timestamp: Date.now()
                    };
                    chat.conversation.push(systemMsg);
                    saveData();
                    renderMessages(chatId, chatType);
                }
            } else if (type === 'transfer' && message.sender !== appData.user.id && message.content.status === 'sent') {
                const modalId = 'transfer-receive-modal';
                const html = `
                    <div class="modal-content">
                        <div class="modal-title">收到转账</div>
                        <p style="text-align: center; font-size: 24px; font-weight: bold;">${formatCurrency(message.content.amount, appData.user.wallet.currency)}</p>
                        <p style="text-align: center; color: #888;">${message.content.remark}</p>
                        <div class="modal-actions">
                            <button class="modal-btn" id="transfer-return-btn">退回</button>
                            <button class="modal-btn primary" id="transfer-claim-btn">收款</button>
                        </div>
                    </div>
                `;
                showModal(modalId, html);

                document.getElementById('transfer-claim-btn').onclick = () => {
                    const amount = parseFloat(message.content.amount);
                    appData.user.wallet.balance += amount;
                    const senderName = chatType === 'group' ? (chat.members.find(m => m.id === message.sender)?.name || '群成员') : (chat.remark || chat.name);
                    appData.user.wallet.transactions.push({ type: '转账', amount: amount, details: `收到${senderName}的转账`, timestamp: Date.now() });
                    message.content.status = 'claimed';
                    
                    const systemMsg = { id: Date.now(), type: 'system', content: { content: `${appData.user.nickname} 已收款` }, timestamp: Date.now() };
                    chat.conversation.push(systemMsg);
                    saveData();
                    renderMessages(chatId, chatType);
                    closeModal(modalId);
                };

                document.getElementById('transfer-return-btn').onclick = () => {
                    message.content.status = 'returned';
                    const systemMsg = { id: Date.now(), type: 'system', content: { content: `${appData.user.nickname} 已退回转账` }, timestamp: Date.now() };
                    chat.conversation.push(systemMsg);
                    saveData();
                    renderMessages(chatId, chatType);
                    closeModal(modalId);
                };
            } else if (type === 'music') {
                playSong(message.content.id);
            }
        }

        function showForwardedContentModal(event, messageId, chatId, chatType) {
            event.stopPropagation();
            const chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const message = chat.conversation.find(m => m.id == messageId);
            if (!message || message.type !== 'forward') return;

            const modalId = 'view-forwarded-messages-modal';
            
            const messagesHtml = message.content.messages.map(msg => {
                const isSent = msg.sender === appData.user.id;
                const sender = isSent ? appData.user : (appData.contacts.find(c => c.id == msg.sender) || {name: '未知', nickname: '未知', avatar: 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg'});
                let content = '';
                switch(msg.type) {
                    case 'text': content = msg.content.content; break;
                    case 'image': content = `<img src="${msg.content.url}" style="max-width: 100px; border-radius: 4px;">`; break;
                    default: content = `[${msg.type}]`; break;
                }
                return `
                    <div class="message-row ${isSent ? 'sent' : 'received'}">
                        <div class="message-body">
                            <div class="message-avatar-wrapper"><img src="${sender.avatar}" class="message-avatar"></div>
                            <div class="message-content-wrapper">
                                <div class="message-bubble">${content}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const modalHtml = `
                <div class="modal-content" style="padding: 0; width: 90%; max-width: 340px; height: 80%; display: flex; flex-direction: column;" onclick="event.stopPropagation();">
                    <div class="wechat-header" style="flex-shrink: 0;">
                        <span class="header-title">聊天记录</span>
                        <div class="header-right" style="font-size: 16px;" onclick="closeModal('${modalId}')">关闭</div>
                    </div>
                    <div class="content-area" style="padding: 10px;">${messagesHtml}</div>
                </div>
            `;
            showModal(modalId, modalHtml);
            document.getElementById(modalId).onclick = () => closeModal(modalId);
        }

        // --- Group Chat Functions ---
        function renderCreateGroupChatPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-bt              </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="confirm-mute-btn">确认</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('confirm-mute-btn').onclick = () => {
                const days = parseInt(document.getElementById('mute-days').value) || 0;
                const hours = parseInt(document.getElementById('mute-hours').value) || 0;
                const minutes = parseInt(document.getElementById('mute-minutes').value) || 0;
                const duration = (days * 24 * 3600 + hours * 3600 + minutes * 60) * 1000;
                if (duration <= 0) { alert('禁言时长必须大于0'); return; }
                
                const group = appData.groups.find(g => g.id == groupId);
                group.mutedMembers[memberId] = Date.now() + duration;
                saveData();
                closeModal(modalId);
            };
        }

        function unmuteMember(groupId, memberId) {
            const group = appData.groups.find(g => g.id == groupId);
            delete group.mutedMembers[memberId];
            saveData();
        }

        function editGroupName(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const newName = prompt('请输入新的群聊名称：', group.name);
            if (newName && newName.trim()) {
                group.name = newName.trim();
                saveData();
                renderGroupChatSettingsPage(document.getElementById('group-chat-settings-page'), groupId);
                renderConversationPage(document.getElementById('conversation-page'), groupId, 'group');
            }
        }

        function editGroupAvatar(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const modalId = 'edit-group-avatar-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">更换群头像</div>
                    <img src="${group.avatar}" class="avatar-upload-preview" id="group-avatar-preview-modal" onclick="document.getElementById('group-avatar-input-modal').click()">
                    <input type="file" id="group-avatar-input-modal" class="file-input" accept="image/jpeg, image/gif">
                    <button class="modal-btn primary" id="save-group-avatar-btn" style="margin-top: 15px;">保存</button>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('group-avatar-input-modal').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    document.getElementById('group-avatar-preview-modal').src = dataUrl;
                });
            };
            document.getElementById('save-group-avatar-btn').onclick = () => {
                group.avatar = document.getElementById('group-avatar-preview-modal').src;
                saveData(true);
                renderGroupChatSettingsPage(document.getElementById('group-chat-settings-page'), groupId);
                closeModal(modalId);
            };
        }

        function editGroupAnnouncement(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const newAnnouncement = prompt('请输入群公告 (上限600字)：', group.announcement);
            if (newAnnouncement !== null) {
                group.announcement = newAnnouncement.substring(0, 600);
                saveData();
                const systemMsg = { id: Date.now(), type: 'system', content: { content: `群主发布了新公告: ${group.announcement}` }, timestamp: Date.now() };
                group.conversation.push(systemMsg);
                renderMessages(groupId, 'group');
            }
        }

        function renderGroupMemberManagementPage(container, groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            if (!group) { goBack(); return; }
            const isUserAdmin = group.adminIds.includes(appData.user.id);

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">群成员管理</span>
                    ${isUserAdmin ? `<div class="header-right" onclick="showAddGroupMembersModal(${groupId})"><i class="fas fa-user-plus"></i></div>` : ''}
                </div>
                <div class="content-area group-member-list list-view" id="group-members-list"></div>
            `;
            renderGroupMembersList(groupId);
        }

        function renderGroupMembersList(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const listContainer = document.getElementById('group-members-list');
            const isUserAdmin = group.adminIds.includes(appData.user.id);

            listContainer.innerHTML = group.members.map(member => {
                const isMemberAdmin = group.adminIds.includes(member.id);
                return `
                    <div class="list-item">
                        <img src="${member.avatar}" class="avatar">
                        <div class="details"><span class="name">${member.name} ${isMemberAdmin ? '(管理员)' : ''}</span></div>
                        <div class="member-actions">
                            ${isUserAdmin && member.id !== appData.user.id ? `
                                <button onclick="toggleGroupAdmin(${groupId}, '${member.id}')">${isMemberAdmin ? '取消' : '设为管理员'}</button>
                                <button onclick="removeGroupMember(${groupId}, '${member.id}')">移出</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddGroupMembersModal(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const existingMemberIds = group.members.map(m => m.id);
            const availableContacts = appData.contacts.filter(c => !existingMemberIds.includes(c.id));

            const modalId = 'add-group-members-modal';
            let html = `
                <div class="modal-content">
                    <div class="modal-title">添加群成员</div>
                    <div class="list-view contact-selection-list" id="add-members-selection">
            `;
            if (availableContacts.length === 0) {
                html += '<div style="text-align:center; padding: 20px;">暂无更多好友可添加</div>';
            } else {
                html += availableContacts.map(contact => `
                    <div class="list-item">
                        <input type="checkbox" data-member-id="${contact.id}">
                        <img src="${contact.avatar}" class="avatar">
                        <div class="details"><span class="name">${contact.name}</span></div>
                    </div>
                `).join('');
            }
            html += `</div><button class="modal-btn primary" id="confirm-add-members-btn" style="margin-top: 15px;">添加</button></div>`;
            showModal(modalId, html);

            document.getElementById('confirm-add-members-btn').onclick = () => {
                const selectedCheckboxes = document.querySelectorAll('#add-members-selection input:checked');
                const newMemberIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.memberId));
                const newMembers = appData.contacts.filter(c => newMemberIds.includes(c.id));
                group.members.push(...newMembers);
                saveData();
                renderGroupMembersList(groupId);
                closeModal(modalId);
            };
        }

        function toggleGroupAdmin(groupId, memberId) {
            const group = appData.groups.find(g => g.id == groupId);
            const index = group.adminIds.indexOf(memberId);
            if (index > -1) group.adminIds.splice(index, 1);
            else group.adminIds.push(memberId);
            saveData();
            renderGroupMembersList(groupId);
        }

        function removeGroupMember(groupId, memberId) {
            if (confirm('确定要将该成员移出群聊吗？')) {
                const group = appData.groups.find(g => g.id == groupId);
                group.members = group.members.filter(m => m.id != memberId);
                group.adminIds = group.adminIds.filter(id => id != memberId);
                saveData();
                renderGroupMembersList(groupId);
            }
        }

        function leaveGroupChat(groupId) {
            if (confirm('确定要退出群聊吗？')) {
                appData.groups = appData.groups.filter(g => g.id != groupId);
                saveData(true, () => { goBack(); goBack(); });
            }
        }

        // --- Music Player ---
        let audioPlayer = new Audio();
        audioPlayer.onended = () => playNextSong();

        function renderMusicLibraryPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">音乐库</span>
                    <div class="header-right" onclick="showPage('music-settings-page', renderMusicSettingsPage)"><i class="fas fa-cog"></i></div>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-view">
                        <div class="list-item" onclick="showAddMusicModal()">
                            <div class="details"><span class="name">从URL导入</span></div><i class="fas fa-plus chevron"></i>
                        </div>
                        <div class=            <div class="list-item" onclick="showPage('player-beautify-page', renderPlayerBeautifyPage)">
                        <div class="details"><span class="name">播放器美化</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        function renderPlayerBeautifyPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">播放器美化</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>更换播放器图片</label>
                        <img src="${appData.music.playerImage}" class="avatar-upload-preview" id="player-image-preview" onclick="document.getElementById('player-image-input').click()">
                        <input type="file" id="player-image-input" class="file-input" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>更换播放器背景图片</label>
                        <img src="${appData.music.playerBackground}" class="avatar-upload-preview" id="player-bg-preview" onclick="document.getElementById('player-bg-input').click()">
                        <input type="file" id="player-bg-input" class="file-input" accept="image/*">
                    </div>
                </div>
            `;
            document.getElementById('player-image-input').onchange = e => handleImageUpload(e.target.files[0], url => {
                appData.music.playerImage = url;
                saveData();
                applyBeautifySettings();
                document.getElementById('player-image-preview').src = url;
            });
            document.getElementById('player-bg-input').onchange = e => handleImageUpload(e.target.files[0], url => {
                appData.music.playerBackground = url;
                saveData();
                applyBeautifySettings();
                document.getElementById('player-bg-preview').src = url;
            });
        }

        // --- Long Term Memory & Diary ---
        function renderLongTermMemoryPage(container, contactId) {
            const contact = appData.contacts.find(c => c.id == contactId);
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">长期记忆</span>
                </div>
                <div class="content-area" id="memory-list" style="padding: 15px;">加载中...</div>
            `;
            generateAndRenderMemory(contactId);
        }

        async function generateAndRenderMemory(contactId) {
            const contact = appData.contacts.find(c => c.id == contactId);
            const memoryList = document.getElementById('memory-list');
            try {
                const history = contact.conversation.slice(-100).map(m => `${m.sender === 'me' ? appData.user.nickname : contact.name}: ${m.content.content}`).join('\n');
                const prompt = `请以客观的第三人称视角，总结本次聊天记录中的关键事件、地点变更和人物关系变化。可以掺杂个人感情，像写日记一样，要贴合自己的人设，结合聊天记录中的话题和事件，请分条列出每条不超过100字。总计字数上限5000字。\n\n聊天记录：\n${history}`;
                const summary = await getAiReply(contactId, prompt);
                memoryList.innerHTML = summary.map(item => `<div class="list-item" style="flex-direction: column; align-items: flex-start; background: var(--wechat-bg); border-radius: 8px; margin-bottom: 10px;"><p>${item}</p></div>`).join('');
            } catch (e) {
                memoryList.innerHTML = `<p style="padding: 20px; color: red;">生成记忆失败: ${e.message}</p>`;
            }
        }

        function renderDiaryPage(container, chatId) {
            const contact = appData.contacts.find(c => c.id == chatId);
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">${contact.name}的日记</span>
                </div>
                <div class="content-area" id="diary-content" style="padding: 25px; font-family: 'DiaryFont', serif; color: #3a2e28; line-height: 1.8; font-size: 17px; white-space: pre-wrap; background-image: url('https://img.heliar.top/file/1764077275005_Screenshot_2025_1125_181250.png'); background-size: cover;">加载日记中...</div>
            `;
            generateAndRenderDiary(chatId);
        }

        async function generateAndRenderDiary(chatId) {
            const contact = appData.contacts.find(c => c.id == chatId);
            const diaryContent = document.getElementById('diary-content');
            try {
                const history = contact.conversation.slice(-100).map(m => `${m.sender === appData.user.id ? appData.user.nickname : contact.name}: ${m.content.content}`).join('\n');
                const prompt = `请你以【${contact.name}】的身份和第一人称视角，结合你的角色设定(${contact.persona})以及下面的聊天记录，写一篇日记。日记内容要完全贴合你的人设，可以是对聊天内容的感想，也可以是基于聊天内容发散出的、符合你身份的日常记录或心理活动。字数上限5000字。\n\n聊天记录：\n${history}`;
                const diaryText = (await getAiReply(chatId, prompt)).join('\n\n');
                diaryContent.textContent = diaryText;
            } catch (e) {
                diaryContent.innerHTML = `<p style="padding: 20px; color: red;">生成日记失败: ${e.message}</p>`;
            }
        }

        // --- Poke Feature ---
        function renderPokeSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">戳一戳设置</span>
                </div>
                <div class="content-area form-page">
                    <h3>设置我的戳一戳</h3>
                    <div class="form-group">
                        <label>动作</label>
                        <select id="poke-user-action">
                            ${['拍了拍', '揉了揉', '戳了戳', '捏了捏', '弹了弹'].map(a => `<option value="${a}" ${appData.settings.poke.userToChar.action === a ? 'selected' : ''}>${a}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>后缀 (例如：的脸并说了句抖爱慕)</label>
                        <input type="text" id="poke-user-suffix" value="${appData.settings.poke.userToChar.suffix}">
                    </div>
                    <div class="list-divider"></div>
                    <h3>设置对方的戳一戳</h3>
                    <div class="form-group">
                        <label>动作</label>
                        <select id="poke-char-action">
                            ${['拍了拍', '揉了揉', '戳了戳', '捏了捏', '弹了弹'].map(a => `<option value="${a}" ${appData.settings.poke.charToUser.action === a ? 'selected' : ''}>${a}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>后缀</label>
                        <input type="text" id="poke-char-suffix" value="${appData.settings.poke.charToUser.suffix}">
                    </div>
                    <button class="form-btn" id="save-poke-btn">保存</button>
                </div>
            `;
            document.getElementById('save-poke-btn').onclick = () => {
                appData.settings.poke.userToChar.action = document.getElementById('poke-user-action').value;
                appData.settings.poke.userToChar.suffix = document.getElementById('poke-user-suffix').value;
                appData.settings.poke.charToUser.action = document.getElementById('poke-char-action').value;
                appData.settings.poke.charToUser.suffix = document.getElementById('poke-char-suffix').value;
                saveData(true);
            };
        }

        function triggerPoke(chatId, chatType, targetId) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            
            if (chatType === 'individual') {
                const pokeSetting = appData.settings.poke.userToChar;
                const pokerName = appData.user.nickname;
                const target = appData.contacts.find(c => c.id == targetId);
                const targetName = target.remark || target.name;
                
                const pokeText = `${pokerName} ${pokeSetting.action}了 ${targetName} ${pokeSetting.suffix}`;
                
                const systemMsg = {
                    id: Date.now(), type: 'system',
                    content: { content: pokeText },
                    timestamp: Date.now()
                };
                chat.conversation.push(systemMsg);
                saveData();
                renderMessages(chatId, chatType);
            }
        }

        // --- Helper Functions ---
        function escapeSrcDoc(html) {
            return html.replace(/"/g, '&quot;');
        }

        function formatCurrency(cnyAmount, targetCurrency, showSymbol = false) {
            const rateInfo = exchangeRates[targetCurrency];
            if (!rateInfo) return `${cnyAmount.toFixed(2)} CNY`;
            
            const convertedAmount = cnyAmount * rateInfo.rate;
            
            const options = {
                style: 'currency',
                currency: targetCurrency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            };
            
            let formatted = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(convertedAmount);
            
            if (showSymbo▲▲ 优化：查看对方余额 (API驱动 + 防火墙) ▲▲▲
        async function showCharBalancePage(container, charId) {
            const contact = appData.contacts.find(c => c.id == charId);
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">${contact.name}的余额</span>
                </div>
                <div class="content-area" style="padding: 15px; text-align: center;">
                    <p><i class="fas fa-spinner fa-spin"></i> 正在通过API获取信息，请稍候...</p>
                </div>
            `;
            try {
                const prompt = `根据角色设定：【${contact.persona}】，请你生成该角色的财务状况，必须严格遵循以下JSON格式，不要添加任何额外解释：
                {
                  "bank_balance": "银行卡余额(数字)",
                  "wallet_balance": "钱包余额(数字)",
                  "alipay_balance": "支付宝余额(数字)",
                  "recent_expenses": [
                    {"item": "支出项目1", "amount": "金额(数字)", "date": "YYYY-MM-DD"},
                    {"item": "支出项目2", "amount": "金额(数字)", "date": "YYYY-MM-DD"}
                  ]
                }`;
                const balanceDataStr = (await getAiReply(charId, prompt))[0];
                
                // ▲▲▲ 防火墙：解析JSON ▲▲▲
                let balanceData;
                try {
                    balanceData = JSON.parse(balanceDataStr);
                } catch (parseError) {
                    throw new Error(`API返回格式错误，无法解析为JSON: ${parseError.message}`);
                }

                // ▲▲▲ 防火墙：验证数据结构 ▲▲▲
                if (!balanceData || typeof balanceData.bank_balance === 'undefined' || !Array.isArray(balanceData.recent_expenses)) {
                    throw new Error("API返回的数据结构不符合预期。");
                }

                container.querySelector('.content-area').innerHTML = `
                    <div class="list-item"><span>银行卡余额:</span><span class="info">${formatCurrency(parseFloat(balanceData.bank_balance), 'CNY')}</span></div>
                    <div class="list-item"><span>钱包余额:</span><span class="info">${formatCurrency(parseFloat(balanceData.wallet_balance), 'CNY')}</span></div>
                    <div class="list-item"><span>支付宝余额:</span><span class="info">${formatCurrency(parseFloat(balanceData.alipay_balance), 'CNY')}</span></div>
                    <div class="list-divider"></div>
                    <h3>最近开销记录</h3>
                    <div class="list-view">
                        ${balanceData.recent_expenses.map(item => `
                            <div class="list-item">
                                <div class="details">
                                    <span class="name">${item.item}</span>
                                    <p class="subtext">${item.date}</p>
                                </div>
                                <div class="info" style="color: var(--wechat-red);">${formatCurrency(parseFloat(item.amount), 'CNY')}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                container.querySelector('.content-area').innerHTML = `<p style="color: red; padding: 20px;">▲▲▲ 防火墙警告：获取余额失败！<br>${e.message}</p>`;
            }
        }

// 公告栏
        function renderAnnouncementPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">公告栏</span>
                </div>
                <div class="content-area">
                    <h3>📱 【Lovely Phone（简称 LPhone）使用与说明公告】</h3>
                    <p>感谢关注与使用 Lovely Phone（中文昵称“可爱手机”或简称 LPhone），这是一款以 AI 聊天为核心的趣味虚拟通讯小工具。致力于为用户提供轻松有趣的互动体验，同时倡导友善、健康的交流环境，用户可以与自己的mj尽情聊天，需要api哦，api类报错问题一概不回答，可解答bug和使用功能。</p>
                    <h3>🌟 【Lphone 简介】</h3>
                    <ul>
                        <li><b>小手机的名称全称：</b>Lovely Phone（昵称：可爱手机 / LPhone）</li>
                        <li><b>该小手机功能定位：</b>AI 智能聊天伙伴，模拟手机交互形式，带来沉浸式陪伴体验。</li>
                        <li><b>至于更新方式：</b>更新节奏自由随缘，不定期优化与维护，功能更新看个人感觉，如果太过麻烦的应用菜单功能可能不更。</li>
                        <li><b>关于Bug 处理：</b>如果发现问题，会根据bug的情况不定期修复，敬请理解与包容。</li>
                    </ul>
                    <h3>📜 【使用LPhone 须知】</h3>
                    <p>为保障良好的创作与交流氛围，请各位用户遵守如下约定：</p>
                    <ol>
                        <li>❌ 禁止任何形式的二次传播（包括但不限于转载、上传至公共平台、分享给非授权用户等），否则会被直接永久拉黑并挂人。</li>
                        <li>❌ 禁止二次修改、篡改原始内容或程序文件，然后再进行售卖等行为，本小手机暂时纯免费，截止2025.12.31日起可能会小偿3.14r。</li>
                        <li>❌ 禁止使用本小手机进行任何不良、违规、违法活动，禁止用该小手机导入酒馆角色卡，导入别人的角色卡时务必需要经过授权。</li>
                        <li>❌ 严禁发布或讨论任何涉及政治敏感、违反法律法规及相关政策的内容。</li>
                        <li>✅ 鼓励积极、友善、富有创意的交流与共创，共建温暖社区。</li>
                        <li>❌ 禁止搞小团体孤立、辱骂、诋毁群内其他老师，尊重他人xp尊重他人，禁止一边使用别的老师的东西一边在背地里辱骂、诋毁该老师，绝不允许吃饭打厨子的行为，否则会被踢出群后不再进入。</li>
                        <li>❌ 禁止未经授权的情况下将别的老师的角色卡或角色形象图搬运到其他地方私自使用并公开给他人使用当福利或商用等行为，绝不允许这种行为发生，如有该情况请联系管理踢出群处理。</li>
                    </ol>
                    <h3>💬 【加入社群交流】</h3>
                    <p>欢迎加入 Lovely Phone 的 QQ 交流群，与众多老师与用户一起分享作品、交流心得、获取最新动态～群内不定时有老师们精心制作的“🍚”哦！</p>
                    <p>聊天群加入即可：</p>
                    <ul>
                        <li> （未满）群号：626108411</li>
                </ul>
                    <p>🔔 提示：为维护良好秩序，入群后请自觉遵守群规及上述使用须知，加群后请自觉把群昵称后缀改为小红书的昵称哦，方便辨认，更好的避免串子和贩子，没改名的一律踹出群聊永不进入。</p>
                    <p style="text-align: center; margin-top: 20px;">💖 感谢支持与喜爱，愿 Lovely Phone 为你的生活增添一抹柔软与乐趣 💖</p>
                </div>
            `;
        }

        // ▲▲▲ 优化：外卖和礼物功能 (API驱动 + 防火墙) ▲▲▲
        async function refreshItems(chatId, type, query = '') {
            const listEl = document.getElementById(`${type}-list`);
            if (!listEl) return;
            listEl.innerHTML = `<p style="text-align:center; color:var(--wechat-text-secondary); padding:50px;"><i class="fas fa-spinner fa-spin"></i> 商品加载中...</p>`;
            
            const isGift = type === 'gift-shop';
            const prompt = isGift 
                ? `请严格按照'礼物名,价格,描述;...'的格式生成36个礼物，描述不超过20字。可以包含吃穿用等各种礼物。例如：'永恒玫瑰,520,一朵永不凋谢的玫瑰;遥控跳蛋,299,小巧强劲，远程遥控;...'. ${query ? `请优先生成与'${query}'相关的礼物。` : ''}`
                : `请严格按照'商品名,价格;...'的格式生成36个外卖商品。${query ? `请优先生成与'${query}'相关的商品。` : ''}`;

            try {
                const itemsStr = (await getAiReply(chatId, prompt))[0];
                if (!itemsStr) throw new Error("API未返回任何内容。");

                const items = itemsStr.split(';').map(item => {
                    const parts = item.split(',');
                    if (isGift) {
                        return parts.length >= 3 ? { name: parts[0].trim(), price: parseFloat(parts[1].trim()), desc: parts.slice(2).join(',').trim() } : null;
                    } else {
                        return parts.length >= 2 ? { name: parts[0].trim(), price: parseFloat(parts[1].trim()) } : null;
                    }
                }).filter(Boolean);

                if (items.length === 0) throw new Error("API返回内容格式不正确，无法解析商品。");

                if (!query && !isGift) appData.delivery.cachedItems = items;
                renderItems(items, type, chatId);
            } catch(e) {
                listEl.innerHTML = `<p style="text-align:center; color:red; padding:50px;">▲▲▲ 防火墙警告：商品加载失败！<br>${e.message}</p>`;
            }
        }

        function renderItems(items, type, chatId) {
            const listEl = document.getElementById(`${type}-list`);
            if (!listEl) return;
            const isGift = type === 'gift-shop';
            listEl.innerHTML = items.map(item => `
                <div class="grid-item">
                    <img src="https://source.unsplash.com/150x100/?${isGift ? 'gift' : 'food'},${encodeURIComponent(item.name)}" alt="${item.name}">
                    <div class="info">
                        <div class="name">${item.name}</div>
                        ${isGift ? `<div class="desc">${item.desc}</div>` : ''}
                        <div class="price">${formatCurrency(item.price, appData.user.wallet.currency)}</div>
                        <button class="action-btn" onclick="${isGift ? `showPurchaseConfirmation('${chatId}', 'gift', '${item.name.replace(/'/g, "\\'")}', ${item.price})` : `addToCart('${item.name.replace(/'/g, "\\'")}', ${item.price})`}">
                            ${isGift ? '赠送' : '加入购物车'}
                        </button>
                    </div>
                </div>
            `).join('') || '<p style="text-align:center; color:var(--wechat-text-secondary); padding:50px;">未找到相关商品</p>';
        }

        // 外卖
        function openDeliveryModal(chatId, chatType) {
            const content = `
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <div class="wechat-header" style="flex-shrink: 0;">
                        <div class="header-left header-back-btn" onclick="closeModal('delivery-modal')"><i class="fas fa-times"></i></div>
                        <span class="header-title">外卖</span>
                        <div class="header-right" onclick="refreshItems('${chatId}', 'delivery')"><i class="fas fa-sync-alt"></i></div>
                    </div>
                    <div class="delivery-search-bar" style="flex-shrink: 0;">
                        <input type="search" placeholder="搜索商家、商品名称" oninput="refreshItems('${chatId}', 'delivery', this.value)">
                    </div>
                    <div class="content-area item-grid" id="delivery-list"></div>
                    <div class="bottom-nav" style="flex-shrink: 0;">
                        <div class="nav-item active" onclick="renderDeliveryHomePageInModal('${chatId}')"><i class="fas fa-store"></i><span>首页</span></div>
                        <div class="n          const languages = {
                'zh-CN': '简体中文', 'zh-TW': '繁体中文 (台湾)', 'zh-HK': '繁体中文 (香港)', 'zh-MO': '繁体中文 (澳门)',
                'en': 'English (英语)', 'ja': '日本語 (日语)', 'ko': '한국어 (韩语)', 'de': 'Deutsch (德语)',
                'fr': 'Français (法语)', 'ru': 'Русский (俄语)', 'es': 'Español (西班牙语)', 'pt': 'Português (葡萄牙语)',
                'it': 'Italiano (意大利语)', 'nl': 'Nederlands (荷兰语)', 'pl': 'Polski (波兰语)', 'sv': 'Svenska (瑞典语)',
                'th': 'ไทย (泰语)', 'vi': 'Tiếng Việt (越南语)', 'id': 'Bahasa Indonesia (印尼语)', 'ms': 'Bahasa Melayu (马来语)',
                'ar': 'العربية (阿拉伯语)', 'hi': 'हिन्दी (印地语)', 'bn': 'বাংলা (孟加拉语)', 'tr': 'Türkçe (土耳其语)',
                'fa': 'فارسی (波斯语)', 'ur': 'اردو (乌尔都语)', 'he': 'עברית (希伯来语)', 'el': 'Ελληνικά (希腊语)',
                'hu': 'Magyar (匈牙利语)', 'cs': 'Čeština (捷克语)', 'ro': 'Română (罗马尼亚语)', 'fi': 'Suomi (芬兰语)',
                'da': 'Dansk (丹麦语)', 'no': 'Norsk (挪威语)', 'uk': 'Українська (乌克兰语)', 'yue': '粤语'
            };
            let optionsHtml = '';
            for (const [code, name] of Object.entries(languages)) {
                optionsHtml += `<option value="${code}" ${appData.settings.charLanguage === code ? 'selected' : ''}>${name}</option>`;
            }
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">角色语言设置</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>选择角色回复时使用的语言</label>
                        <select id="char-language-select">${optionsHtml}</select>
                    </div>
                    <button class="form-btn" onclick="saveCharLanguage()">保存</button>
                </div>
            `;
        }

        function saveCharLanguage() {
            appData.settings.charLanguage = document.getElementById('char-language-select').value;
            saveData(true);
        }

        // 储存空间
        function renderStorageSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">储存空间</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="clearCache()">
                        <div class="details"><span class="name">清理储存</span><p class="subtext">清理AI生成的临时缓存数据，不影响聊天记录。</p></div>
                    </div>
                    <div class="list-item" onclick="clearAllLocalData()">
                        <div class="details"><span class="name" style="color: var(--wechat-red);">清理本地数据</span><p class="subtext">将清空所有角色、聊天记录和设置，此操作不可逆！</p></div>
                    </div>
                </div>
            `;
        }

        function clearCache() {
            if (confirm('确定要清理临时缓存吗？')) {
                appData.delivery.cachedItems = [];
                saveData(true);
            }
        }

        async function clearAllLocalData() {
            if (prompt('此操作将删除所有数据且无法恢复！请输入 "确认删除" 以继续。') === '确认删除') {
                try {
                    const msg = await dataManager.clearAllData();
                    alert(msg + ' 页面将刷新。');
                    location.reload();
                } catch (error) {
                    alert(error);
                }
            } else {
                alert('操作已取消。');
            }
        }

        // 聊天提示音
        function renderNotificationSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">聊天提示音</span>
                </div>
                <div class="content-area form-page">
                    ${['send', 'receive', 'ringtone'].map(type => `
                        <div class="form-group">
                            <label>${{send:'发送提示音', receive:'消息提示音', ringtone:'来电提示音'}[type]}</label>
                            <input type="text" id="sound-url-${type}" placeholder="输入音频URL..." value="${appData.settings.notifications[type] || ''}">
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="form-btn" style="background-color: #aaa; margin: 0; flex: 1;" onclick="document.getElementById('sound-file-${type}').click()">选择文件</button>
                                <button class="form-btn" style="background-color: var(--wechat-blue); margin: 0; flex: 0 0 80px;" onclick="testNotificationSound('${type}')">试听</button>
                            </div>
                            <input type="file" id="sound-file-${type}" class="file-input" accept="audio/*" onchange="handleSoundUpload(this.files[0], '${type}')">
                        </div>
                        <div class="list-divider"></div>
                    `).join('')}
                    <button class="form-btn" onclick="saveNotificationSounds()">保存所有</button>
                </div>
            `;
        }

        function handleSoundUpload(file, type) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById(`sound-url-${type}`).value = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function saveNotificationSounds() {
            appData.settings.notifications.send = document.getElementById('sound-url-send').value;
            appData.settings.notifications.receive = document.getElementById('sound-url-receive').value;
            appData.settings.notifications.ringtone = document.getElementById('sound-url-ringtone').value;
            saveData(true);
            applyBeautifySettings();
        }

        function playNotificationSound(type) {
            const player = document.getElementById(`${type}-sound-player`);
            if (player && player.src) {
                player.currentTime = 0;
                player.play().catch(e => console.error(`无法播放提示音: ${e.message}`));
            }
        }
        
        function testNotificationSound(type) {
            const url = document.getElementById(`sound-url-${type}`).value;
            if (url) {
                const testPlayer = new Audio(url);
                testPlayer.play().catch(e => alert(`试听失败: ${e.message}`));
            } else {
                alert('请先设置URL或选择文件。');
            }
        }

        // 语音通话
        let callTimerInterval;
        let callStartTime;

        function startVoiceCall(chatId, chatType, initiator) {
            if (chatType !== 'individual') { alert('语音通话仅支持单聊。'); return; }
            const contact = appData.contacts.find(c => c.id == chatId);
            if (!contact) return;

            playNotificationSound('ringtone');
            showPage('voice-call-page', renderVoiceCallPage, chatId, initiator);
        }

        function renderVoiceCallPage(container, chatId, initiator) {
            const contact = appData.contacts.find(c => c.id == chatId);
            container.innerHTML = `
                <div class="voice-call-container" style="background-image: url('${contact.avatar}')">
                    <div class="voice-call-header">
                        <img src="${contact.avatar}" class="avatar">
                        <p class="name">${contact.remark || contact.name}</p>
                        <p class="voice-call-status" id="call-status">正在响铃...</p>
                    </div>
                    <div class="voice-call-chat-area" id="call-chat-area"></div>
                    <div class="voice-call-input-bar" id="call-input-bar" style="display: none;">
                        <input type="text" id="call-input" placeholder="输入...">
                    </div>
                    <div class="voice-call-controls" id="call-controls">
                        ${initiator === 'user' ? `
                        <div class="control-btn" onclick="endVoiceCall('${chatId}', 'cancelled')">
                            <div class="icon-wrapper hangup"><i class="fas fa-phone-slash"></i></div>
                            <span>挂断</span>
                        </div>
                        ` : `
                        <div class="control-btn" onclick="endVoiceCall('${chatId}', 'rejected')">
                            <div class="icon-wrapper hangup"><i class="fas fa-phone-slash"></i></div>
                            <span>拒绝</span>
                        </div>
                        <div class="control-btn" onclick="answerVoiceCall('${chatId}')">
                            <div class="icon-wrapper" style="background: var(--wechat-green);"><i class="fas fa-phone"></i></div>
                            <span>接听</span>
                        </div>
                        `}
                    </div>
                </div>
            `;

            if (initiator === 'user') {
                setTimeout(() => answerVoiceCall(chatId), 3000);
            }
        }

        function answerVoiceCall(chatId) {
            document.getElementById('ringtone-player').pause();
            const statusEl = document.getElementById('call-status');
            if (statusEl) statusEl.textContent = '通话中 00:00';
            
            const inputBar = document.getElementById('call-input-bar');
            if (inputBar) inputBar.style.display = 'flex';

            const controls = document.getElementById('call-controls');
            if (controls) {
                controls.innerHTML = `
                    <div class="control-btn" onclick="minimizeVoiceCall('${chatId}')">
                        <div class="icon-wrapper minimize"><i class="fas fa-window-minimize"></i></div>
                        <span>最小化</span>
                    </div>
                    <div class="control-btn" onclick="endVoiceCall('${chatId}', 'ended')">
                        <div class="icon-wrapper hangup"><i class="fas fa-phone-slash"></i></div>
                        <span>挂断</span>
                    </div>
                `;
            }

            callStartTime = Date.now();
            callTimerInterval = setInterval(() => {
                const statusTimerEl = document.getElementById('call-status');
                if (statusTimerEl) {
                    const duration = Math.floor((Date.now() - callStartTime) / 1000);
                    const minutes = String(Math.floor(duration/ 60)).padStart(2, '0');
                    const seconds = String(duration % 60).padStart(2, '0');
                    statusTimerEl.textContent = `通话中 ${minutes}:${seconds}`;
                }
            }, 1000);

            const callInput = document.getElementById('call-input');
            if (callInput) {
                callInput.onkeydown = async (e) => {
                    if (e.key === 'Enter' && callInput.value.trim() !== '') {
                        const text = callInput.value.trim();
                        callInput.value = '';
                        appendCallMessage('user', text);
                        const prompt = `你正在和'${appData.user.nickname}'语音通话。对方刚刚说：“${text}”。请你用简短的口语进行回复。`;
                        const replies = await getAiReply(chatId, prompt);
                        replies.forEach(reply => appendCallMessage('char', reply));
                    }
                };
            }
        }

        function appendCallMessage(sender, text) {
            const chatArea = document.getElementById('call-chat-area');
            if (!chatArea) return;
            const contact = appData.contacts.find(c => c.id == appData.activeChat.id);
            const senderName = sender === 'user' ? appData.user.nickname : (contact.remark || contact.name);
            chatArea.innerHTML += `<p><b>${senderName}:</b> ${text}</p>`;
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function endVoiceCall(chatId, reason) {
            document.getElementById('ringtone-player').pause();
            clearInterval(callTimerInterval);
            let durationText = '';
            if (reason === 'ended' && callStartTime) {
                const duration = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                durationText = `通话时长 ${minutes > 0 ? `${minutes}分` : ''}${seconds}秒`;
            } else if (reason === 'cancelled') {
                durationText = '已取消';
            } else if (reason === 'rejected') {
                durationText = '对方已拒绝';
            }
            
            if (durationText) {
                sendMessage(chatId, 'individual', { duration: durationText }, 'voice_call');
            }
            goBack();
        }

        function minimizeVoiceCall(chatId) {
            const contact = appData.contacts.find(c => c.id == chatId);
            const minimizedWindow = document.createElement('div');
            minimizedWindow.id = 'minimized-call-window';
            minimizedWindow.className = 'minimized-call-window';
            minimizedWindow.innerHTML = `
                <img src="${contact.avatar}" class="avatar">
                <p>${contact.remark || contact.name}</p>
                <p class="status" id="minimized-call-status">通话中...</p>
            `;
            minimizedWindow.onclick = () => {
                document.getElementById('minimized-call-container').innerHTML = '';
                showPage('voice-call-page', renderVoiceCallPage, chatId, 'user');
                // We need to re-establish the call state
                setTimeout(() => answerVoiceCall(chatId), 100);
            };
            document.getElementById('minimized-call-container').appendChild(minimizedWindow);
            goBack();
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            // ▲▲▲ 防火墙：激活码检查 ▲▲▲
            const isActivated = localStorage.getItem('isLPhoneActivated');
            if (!isActivated) {
                const overlay = document.getElementById('activation-overlay');
                overlay.style.display = 'flex';
                document.getElementById('activation-submit-btn').onclick = () => {
                    const input = document.getElementById('activation-code-input').value;
                    if (input.toLowerCase() === 'Evol还是Love') {
                        localStorage.setItem('isLPhoneActivated', 'true');
                        overlay.style.display = 'none';
                        initializeApp();
                    } else {
                        alert('激活码不正确，请重新输入。');
                    }
                };
            } else {
                initializeApp();
            }
        });

        async function initializeApp() {
            await dataManager.init();
            await loadData();
            applyBeautifySettings();
            renderMainContent('chat-list');

            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelector('.tab-item.active').classList.remove('active');
                    tab.classList.add('active');
                    pageHistory = ['main-container'];
                    renderMainContent(tab.dataset.page);
                });
            });
            
            checkAndPostCharMoments();
            if (appData.settings.backgroundInteraction.enabled) startBackgroundInteraction();
        }
    </script>
</body>
</html>
